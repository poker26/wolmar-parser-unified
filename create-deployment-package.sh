#!/bin/bash

# Wolmar Parser - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð° Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
# ÐÐ²Ñ‚Ð¾Ñ€: Wolmar Team
# Ð’ÐµÑ€ÑÐ¸Ñ: 2.0.0

set -e

echo "ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°ÐºÐµÑ‚Ð° Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Wolmar Parser..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ð°ÐºÐµÑ‚Ð°
PACKAGE_DIR="wolmar-parser-deployment-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$PACKAGE_DIR"

echo "ðŸ“ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
cp package.json "$PACKAGE_DIR/"
cp package-lock.json "$PACKAGE_DIR/"
cp ecosystem.config.js "$PACKAGE_DIR/"
cp config.js "$PACKAGE_DIR/"
cp config.production.js "$PACKAGE_DIR/"
cp env.example "$PACKAGE_DIR/"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚Ñ‹ Ð·Ð°Ð¿ÑƒÑÐºÐ°
cp start-production.sh "$PACKAGE_DIR/"
cp stop-production.sh "$PACKAGE_DIR/"
cp restart-production.sh "$PACKAGE_DIR/"
cp deploy.sh "$PACKAGE_DIR/"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
cp server.js "$PACKAGE_DIR/"
cp catalog-server.js "$PACKAGE_DIR/"
cp admin-server.js "$PACKAGE_DIR/"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐµÑ€Ð²Ð¸ÑÑ‹
cp auth-service.js "$PACKAGE_DIR/"
cp collection-service.js "$PACKAGE_DIR/"
cp collection-price-service.js "$PACKAGE_DIR/"
cp metals-price-service.js "$PACKAGE_DIR/"
cp winner-ratings-service.js "$PACKAGE_DIR/"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð°Ñ€ÑÐµÑ€Ñ‹
cp catalog-parser.js "$PACKAGE_DIR/"
cp numismat-parser.js "$PACKAGE_DIR/"
cp improved-predictions-generator.js "$PACKAGE_DIR/"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
cp -r catalog-public "$PACKAGE_DIR/"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
mkdir -p "$PACKAGE_DIR/logs"
mkdir -p "$PACKAGE_DIR/catalog-images"
mkdir -p "$PACKAGE_DIR/backup"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ
cp DEPLOYMENT-GUIDE.md "$PACKAGE_DIR/"
cp README.md "$PACKAGE_DIR/"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .gitignore
cat > "$PACKAGE_DIR/.gitignore" << 'EOF'
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# Logs
logs/
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*

# Runtime data
pids/
*.pid
*.seed
*.pid.lock

# Coverage directory used by tools like istanbul
coverage/
*.lcov

# nyc test coverage
.nyc_output

# Grunt intermediate storage
.grunt

# Bower dependency directory
bower_components

# node-waf configuration
.lock-wscript

# Compiled binary addons
build/Release

# Dependency directories
node_modules/
jspm_packages/

# TypeScript cache
*.tsbuildinfo

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# dotenv environment variables file
.env
.env.test

# parcel-bundler cache
.cache
.parcel-cache

# Next.js build output
.next

# Nuxt.js build / generate output
.nuxt
dist

# Gatsby files
.cache/
public

# Storybook build outputs
.out
.storybook-out

# Temporary folders
tmp/
temp/

# Editor directories and files
.vscode/
.idea/
*.swp
*.swo
*~

# OS generated files
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# Project specific
catalog-images/
backup/
*.tar.gz
*.zip

# PM2 logs
.pm2/

# Database
*.sqlite
*.db

# Test files
test-results/
coverage/

# Build artifacts
build/
dist/
EOF

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ README Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
cat > "$PACKAGE_DIR/README-DEPLOY.md" << 'EOF'
# ðŸš€ Wolmar Parser - Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

## ðŸ“‹ Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°

### 1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
```bash
# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js 18+
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2
sudo npm install -g pm2

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Google Chrome
wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
sudo apt update
sudo apt install -y google-chrome-stable
```

### 2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
```bash
# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
cp env.example .env
nano .env  # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
npm install --production
```

### 3. Ð—Ð°Ð¿ÑƒÑÐº
```bash
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
./deploy.sh

# Ð˜Ð»Ð¸ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
./start-production.sh
```

### 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°
```bash
# Ð¡Ñ‚Ð°Ñ‚ÑƒÑ
pm2 status

# Ð›Ð¾Ð³Ð¸
pm2 logs

# Ð’ÐµÐ±-Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ
# ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐµÑ€Ð²ÐµÑ€: http://localhost:3001
# ÐšÐ°Ñ‚Ð°Ð»Ð¾Ð³: http://localhost:3000
```

## ðŸ”§ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ

```bash
# Ð—Ð°Ð¿ÑƒÑÐº
./start-production.sh

# ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
./stop-production.sh

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº
./restart-production.sh

# ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹
./deploy.sh
```

## ðŸ“ž ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°

ÐŸÑ€Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ñ…:
1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: `pm2 logs`
2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ: `pm2 status`
3. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: `pm2 restart all`

ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: DEPLOYMENT-GUIDE.md
EOF

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð²
echo "ðŸ—œï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð°..."
tar -czf "${PACKAGE_DIR}.tar.gz" "$PACKAGE_DIR"

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
echo "âœ… ÐŸÐ°ÐºÐµÑ‚ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ ÑÐ¾Ð·Ð´Ð°Ð½: ${PACKAGE_DIR}.tar.gz"
echo "ðŸ“ Ð Ð°Ð·Ð¼ÐµÑ€ Ð°Ñ€Ñ…Ð¸Ð²Ð°: $(du -h "${PACKAGE_DIR}.tar.gz" | cut -f1)"
echo ""
echo "ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°ÐºÐµÑ‚Ð°:"
ls -la "$PACKAGE_DIR"

echo ""
echo "ðŸš€ Ð”Ð»Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:"
echo "1. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€"
echo "2. Ð Ð°ÑÐ¿Ð°ÐºÑƒÐ¹Ñ‚Ðµ: tar -xzf ${PACKAGE_DIR}.tar.gz"
echo "3. ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ: cd $PACKAGE_DIR"
echo "4. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: ./deploy.sh"
echo ""
echo "ðŸ“– ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ: DEPLOYMENT-GUIDE.md"

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
rm -rf "$PACKAGE_DIR"

echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾!"
