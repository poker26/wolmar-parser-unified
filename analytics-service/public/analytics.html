<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ - Wolmar Parser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-home mr-2"></i>–ì–ª–∞–≤–Ω–∞—è
                    </a>
                    <a href="/admin" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-cog mr-2"></i>–ê–¥–º–∏–Ω–∫–∞
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-gavel text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">–í—Å–µ–≥–æ —Å—Ç–∞–≤–æ–∫</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-bids">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-bidders">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-hand-paper text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">–†—É—á–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</p>
                        <p class="text-2xl font-bold text-gray-900" id="manual-bids">-</p>
                        <p class="text-xs text-gray-500" id="manual-percentage">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö</p>
                        <p class="text-2xl font-bold text-gray-900" id="suspicious-users">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Tabs -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                    <button onclick="showTab('fast-bids')" id="tab-fast-bids" class="tab-button active border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-bolt mr-2"></i>–ë—ã—Å—Ç—Ä—ã–µ —Å—Ç–∞–≤–∫–∏
                    </button>
                    <button onclick="showTab('autobid-traps')" id="tab-autobid-traps" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-mouse-pointer mr-2"></i>–õ–æ–≤—É—à–∫–∏ –∞–≤—Ç–æ–±–∏–¥–∞
                    </button>
                    <button onclick="showTab('time-patterns')" id="tab-time-patterns" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-clock mr-2"></i>–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
                    </button>
                    <button onclick="showTab('risk-scoring')" id="tab-risk-scoring" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>–°–∫–æ—Ä–∏–Ω–≥ —Ä–∏—Å–∫–æ–≤
                    </button>
                </nav>
            </div>

            <!-- Fast Bids Tab Content -->
            <div id="content-fast-bids" class="tab-content p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">–ê–Ω–∞–ª–∏–∑ –±—ã—Å—Ç—Ä—ã—Ö —Ä—É—á–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</h3>
                    <p class="text-gray-600 mb-4">–ü–æ–∏—Å–∫ —Ä—É—á–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –º–∞–ª—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏</p>
                    <button onclick="loadFastBids(event)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-search mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                    </button>
                </div>
                
                <div id="fast-bids-results" class="hidden">
                    <div class="mb-4">
                        <span id="fast-bids-count" class="text-sm text-gray-600"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–í—Å–µ–≥–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö (< 1 —Å–µ–∫)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö (< 5 —Å–µ–∫)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ë—ã—Å—Ç—Ä–µ–π—à–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞</th>
                                </tr>
                            </thead>
                            <tbody id="fast-bids-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Autobid Traps Tab Content -->
            <div id="content-autobid-traps" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">–ê–Ω–∞–ª–∏–∑ –ª–æ–≤—É—à–µ–∫ –∞–≤—Ç–æ–±–∏–¥–∞</h3>
                    <p class="text-gray-600 mb-4">–ü–æ–∏—Å–∫ –ª–æ—Ç–æ–≤ —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é, –≥–¥–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∞–≤—Ç–æ–±–∏–¥</p>
                    <button onclick="loadAutobidTraps(event)" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                        <i class="fas fa-search mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                    </button>
                    <button onclick="loadSuspiciousUsers(event)" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 ml-2">
                        <i class="fas fa-users mr-2"></i>–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    </button>
                </div>
                
                <div id="autobid-traps-results" class="hidden">
                    <div class="mb-4">
                        <span id="autobid-traps-count" class="text-sm text-gray-600"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ê—É–∫—Ü–∏–æ–Ω/–õ–æ—Ç</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–†–æ—Å—Ç –æ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ç–∞–≤–æ–∫</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞</th>
                                </tr>
                            </thead>
                            <tbody id="autobid-traps-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="content-time-patterns" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</h3>
                    <p class="text-gray-600 mb-4">–ü–æ–∏—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –±–æ—Ç-—Å–µ—Ç–∏)</p>
                    <button onclick="loadTemporalPatterns(event)" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-search mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑
                    </button>
                </div>
                
                <div id="temporal-patterns-results" class="hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <span id="temporal-patterns-count" class="text-sm text-gray-600"></span>
                        <div class="flex space-x-2">
                            <button onclick="toggleView('table')" id="table-view-btn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                <i class="fas fa-table mr-1"></i>–¢–∞–±–ª–∏—Ü–∞
                            </button>
                            <button onclick="toggleView('graph')" id="graph-view-btn" class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm">
                                <i class="fas fa-project-diagram mr-1"></i>–ì—Ä–∞—Ñ
                            </button>
                        </div>
                    </div>
                    
                    <!-- –¢–∞–±–ª–∏—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
                    <div id="table-view" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ª–æ—Ç–æ–≤</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞</th>
                                </tr>
                            </thead>
                            <tbody id="temporal-patterns-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- –ì—Ä–∞—Ñ–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -->
                    <div id="graph-view" class="hidden">
                        <div class="bg-white rounded-lg border p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-semibold">–ì—Ä–∞—Ñ –±–æ—Ç-—Å–µ—Ç–µ–π</h4>
                                <div class="flex space-x-2">
                                    <button onclick="resetGraph()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm">
                                        <i class="fas fa-undo mr-1"></i>–°–±—Ä–æ—Å
                                    </button>
                                    <button onclick="exportGraph()" class="px-3 py-1 bg-green-500 text-white rounded text-sm">
                                        <i class="fas fa-download mr-1"></i>–≠–∫—Å–ø–æ—Ä—Ç
                                    </button>
                                </div>
                            </div>
                            <div id="graph-container" class="w-full border rounded" style="height: 600px;"></div>
                            
                            <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">–†–∞–∑–º–µ—Ä —É–∑–ª–æ–≤</h5>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">–¶–≤–µ—Ç —É–∑–ª–æ–≤</h5>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                                            <span>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                                            <span>–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                                            <span>–í–Ω–∏–º–∞–Ω–∏–µ</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">–¢–æ–ª—â–∏–Ω–∞ —Å–≤—è–∑–µ–π</h5>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-8 h-1 bg-gray-400 mr-2"></div>
                                            <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">–¶–≤–µ—Ç —Å–≤—è–∑–µ–π</h5>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-4 h-1 bg-red-500 mr-2"></div>
                                            <span>‚â§1 —Å–µ–∫</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-4 h-1 bg-orange-500 mr-2"></div>
                                            <span>‚â§3 —Å–µ–∫</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-4 h-1 bg-yellow-500 mr-2"></div>
                                            <span>‚â§5 —Å–µ–∫</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="content-risk-scoring" class="tab-content p-6 hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">–°–∫–æ—Ä–∏–Ω–≥ —Ä–∏—Å–∫–æ–≤</h3>
                <p class="text-gray-600">–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</p>
            </div>
        </div>
    </main>

    <!-- Modal –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ª–æ—Ç–∞ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ index.html) -->
    <div id="lotModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modalTitle" class="text-xl font-bold text-gray-800">–î–µ—Ç–∞–ª–∏ –ª–æ—Ç–∞</h3>
                        <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="modalContent">
                        <!-- Modal content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞–≤–æ–∫ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ index.html) -->
    <div id="bidsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="flex items-center justify-between p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫</h3>
                    <button onclick="closeBidsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                    <div id="bidsLoading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                        <p class="mt-2 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞–≤–æ–∫...</p>
                    </div>
                    <div id="bidsContent" class="hidden">
                        <div id="bidsSummary" class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">–í—Å–µ–≥–æ —Å—Ç–∞–≤–æ–∫:</span>
                                <span id="bidsCount" class="font-semibold text-gray-800"></span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–í—Ä–µ–º—è</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–£—á–∞—Å—Ç–Ω–∏–∫</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–°—É–º–º–∞</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–¢–∏–ø</th>
                                    </tr>
                                </thead>
                                <tbody id="bidsTableBody" class="divide-y divide-gray-200">
                                    <!-- Bids will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="bidsEmpty" class="text-center py-8 hidden">
                            <i class="fas fa-gavel text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞–≤–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeButton = document.getElementById(`tab-${tabName}`);
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
        }

        // Load dashboard stats
        async function loadStats() {
            try {
                const response = await fetch('/api/analytics/dashboard-stats');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('total-bids').textContent = result.data.totalBids.toLocaleString();
                    document.getElementById('total-bidders').textContent = result.data.totalBidders.toLocaleString();
                    document.getElementById('manual-bids').textContent = result.data.manualBids.toLocaleString();
                    document.getElementById('manual-percentage').textContent = `${result.data.manualBidPercentage}% –æ—Ç –≤—Å–µ—Ö —Å—Ç–∞–≤–æ–∫`;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // Load fast manual bids analysis
        async function loadFastBids(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...';
                button.disabled = true;

                const response = await fetch('/api/analytics/fast-manual-bids');
                const result = await response.json();
                
                if (result.success) {
                    displayFastBids(result.data);
                    document.getElementById('fast-bids-count').textContent = `–ù–∞–π–¥–µ–Ω–æ ${result.data.length} –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
                    document.getElementById('fast-bids-results').classList.remove('hidden');
                } else {
                    if (result.error === '–ê–Ω–∞–ª–∏–∑ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω') {
                        alert(result.message);
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + result.error);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö —Å—Ç–∞–≤–æ–∫:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            } finally {
                button.innerHTML = '<i class="fas fa-search mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
                button.disabled = false;
            }
        }

        // Display fast bids results
        function displayFastBids(data) {
            const tbody = document.getElementById('fast-bids-table-body');
            tbody.innerHTML = '';

            data.forEach(user => {
                const row = document.createElement('tr');
                
                // Risk level styling
                let riskClass = 'text-gray-600';
                let riskIcon = '';
                if (user.risk_level === '–ö–†–ò–¢–ò–ß–ï–°–ö–ò –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û') {
                    riskClass = 'text-red-600 font-semibold';
                    riskIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (user.risk_level === '–ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û') {
                    riskClass = 'text-orange-600 font-medium';
                    riskIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (user.risk_level === '–í–ù–ò–ú–ê–ù–ò–ï') {
                    riskClass = 'text-yellow-600';
                    riskIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                } else {
                    riskClass = 'text-green-600';
                    riskIcon = '<i class="fas fa-check-circle text-green-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${user.bidder_login}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${user.suspicious_bids_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold text-red-600">${user.critical_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold text-orange-600">${user.suspicious_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-mono">${parseFloat(user.fastest_interval).toFixed(2)} —Å–µ–∫</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="font-mono">${user.avg_interval} —Å–µ–∫</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${riskClass}">
                        ${riskIcon}${user.risk_level}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load autobid traps analysis
        async function loadAutobidTraps(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–ê–Ω–∞–ª–∏–∑ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
                button.disabled = true;

                const response = await fetch('/api/analytics/autobid-traps');
                const result = await response.json();
                
                if (result.success) {
                    displayAutobidTraps(result.data);
                    document.getElementById('autobid-traps-count').textContent = `–ù–∞–π–¥–µ–Ω–æ ${result.data.length} –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ª–æ—Ç–æ–≤`;
                    document.getElementById('autobid-traps-results').classList.remove('hidden');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
                    if (result.updated_users) {
                        alert(`‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!\n\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n- –ù–∞–π–¥–µ–Ω–æ –ª–æ–≤—É—à–µ–∫ –∞–≤—Ç–æ–±–∏–¥–∞: ${result.data.length}\n- –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${result.updated_users}\n- –û–±–Ω–æ–≤–ª–µ–Ω —Å–∫–æ—Ä–∏–Ω–≥ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö`);
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≤—É—à–µ–∫ –∞–≤—Ç–æ–±–∏–¥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            } finally {
                button.innerHTML = '<i class="fas fa-search mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
                button.disabled = false;
            }
        }

        // Display autobid traps results
        function displayAutobidTraps(data) {
            const tbody = document.getElementById('autobid-traps-table-body');
            tbody.innerHTML = '';

            data.forEach(lot => {
                const row = document.createElement('tr');
                
                // Risk level styling
                let riskClass = 'text-gray-600';
                let riskIcon = '';
                if (lot.risk_level === '–ö–†–ò–¢–ò–ß–ï–°–ö–ò –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û') {
                    riskClass = 'text-red-600 font-semibold';
                    riskIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (lot.risk_level === '–ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û') {
                    riskClass = 'text-orange-600 font-medium';
                    riskIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (lot.risk_level === '–í–ù–ò–ú–ê–ù–ò–ï') {
                    riskClass = 'text-yellow-600';
                    riskIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <span class="text-blue-600 hover:text-blue-800 cursor-pointer" onclick="showLotModal(${lot.lot_id})">
                            ${lot.auction_number}/${lot.lot_number}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${lot.winner_login}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${parseFloat(lot.winning_bid).toLocaleString()} ‚ÇΩ
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${lot.predicted_price ? parseFloat(lot.predicted_price).toLocaleString() + ' ‚ÇΩ' : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-mono font-semibold ${lot.predicted_price_multiplier >= 2.0 ? 'text-red-600' : lot.predicted_price_multiplier >= 1.5 ? 'text-orange-600' : 'text-gray-600'}">
                            ${lot.predicted_price_multiplier ? lot.predicted_price_multiplier + 'x' : 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${lot.total_bids}</span>
                        <div class="text-xs text-gray-500">
                            ${lot.manual_bid_count} —Ä—É—á–Ω—ã—Ö, ${lot.autobid_count} –∞–≤—Ç–æ–±–∏–¥–æ–≤
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${lot.unique_bidders}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${riskClass}">
                        ${riskIcon}${lot.risk_level}
                    </td>
                `;
                
                // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏
                row.classList.add('hover:bg-gray-50', 'cursor-pointer');
                row.onclick = () => showLotModal(lot.lot_id);
                tbody.appendChild(row);
            });
        }
        

        // Load temporal patterns analysis
        async function loadTemporalPatterns(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–ê–Ω–∞–ª–∏–∑...';
                button.disabled = true;

                const response = await fetch('/api/analytics/temporal-patterns');
                const result = await response.json();
                
                if (result.success) {
                    // Save graph data for later use
                    currentGraphData = result.graphData;
                    
                    displayTemporalPatterns(result.data);
                    document.getElementById('temporal-patterns-count').textContent = `–ù–∞–π–¥–µ–Ω–æ ${result.data.length} –≥—Ä—É–ø–ø —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`;
                    document.getElementById('temporal-patterns-results').classList.remove('hidden');
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            } finally {
                button.innerHTML = '<i class="fas fa-search mr-2"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
                button.disabled = false;
            }
        }

        // Display temporal patterns results
        function displayTemporalPatterns(data) {
            const tbody = document.getElementById('temporal-patterns-table-body');
            tbody.innerHTML = '';

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ª–æ—Ç–æ–≤ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
            data.sort((a, b) => b.unique_lots - a.unique_lots);

            data.forEach(group => {
                const row = document.createElement('tr');
                
                // Risk level styling
                let riskClass = 'text-gray-600';
                let riskIcon = '';
                if (group.suspicion_level === '–ö–†–ò–¢–ò–ß–ï–°–ö–ò –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û') {
                    riskClass = 'text-red-600 font-semibold';
                    riskIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (group.suspicion_level === '–ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û') {
                    riskClass = 'text-orange-600 font-medium';
                    riskIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (group.suspicion_level === '–í–ù–ò–ú–ê–ù–ò–ï') {
                    riskClass = 'text-yellow-600';
                    riskIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                } else {
                    riskClass = 'text-green-600';
                    riskIcon = '<i class="fas fa-check-circle text-green-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <div class="flex flex-wrap gap-1">
                            ${group.users.map(user => `
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${user}
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${group.synchronous_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-mono">${group.avg_time_diff} —Å–µ–∫</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${group.unique_lots}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${riskClass}">
                        ${riskIcon}${group.suspicion_level}
                    </td>
                `;
                
                // –î–µ–ª–∞–µ–º —Å—Ç—Ä–æ–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
                row.style.cursor = 'pointer';
                row.classList.add('hover:bg-gray-50');
                row.onclick = () => showTemporalPatternLots(group);
                tbody.appendChild(row);
            });
        }

        // Global variables for graph
        let currentGraphData = null;
        let svg = null;
        let simulation = null;

        // Toggle between table and graph view
        function toggleView(view) {
            const tableView = document.getElementById('table-view');
            const graphView = document.getElementById('graph-view');
            const tableBtn = document.getElementById('table-view-btn');
            const graphBtn = document.getElementById('graph-view-btn');

            if (view === 'table') {
                tableView.classList.remove('hidden');
                graphView.classList.add('hidden');
                tableBtn.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm';
                graphBtn.className = 'px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm';
            } else {
                tableView.classList.add('hidden');
                graphView.classList.remove('hidden');
                tableBtn.className = 'px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm';
                graphBtn.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm';
                
                // Initialize graph if data is available
                if (currentGraphData) {
                    createGraph(currentGraphData);
                }
            }
        }

        // Create D3.js graph
        function createGraph(graphData) {
            const container = document.getElementById('graph-container');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Create SVG
            svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(d3.zoom()
                    .filter(() => !d3.event.button) // –¢–æ–ª—å–∫–æ –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏
                    .on('zoom', (event) => {
                        g.attr('transform', event.transform);
                    }));
            
            const g = svg.append('g');
            
            // Create force simulation with optimized settings
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => Math.sqrt(d.totalSynchronousBids) * 2 + 8))
                .alphaDecay(0.05) // –ë—ã—Å—Ç—Ä–µ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ
                .velocityDecay(0.3); // –ë–æ–ª—å—à–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
            
            // Create links
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links)
                .enter().append('line')
                .attr('stroke', d => getLinkColor(d.avg_time_diff))
                .attr('stroke-width', d => Math.log(d.synchronous_count) * 2)
                .attr('stroke-opacity', 0.8);
            
            // Create nodes
            const node = g.append('g')
                .selectAll('circle')
                .data(graphData.nodes)
                .enter().append('circle')
                .attr('r', d => Math.sqrt(d.totalSynchronousBids) * 3)
                .attr('fill', d => getNodeColor(d.suspicionLevel))
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // Add labels
            const label = g.append('g')
                .selectAll('text')
                .data(graphData.nodes)
                .enter().append('text')
                .text(d => d.name)
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', '#333');
            
            // Add tooltips
            node.append('title')
                .text(d => `${d.name}\n–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫: ${d.totalSynchronousBids}\n–£—Ä–æ–≤–µ–Ω—å: ${d.suspicionLevel}`);
            
            link.append('title')
                .text(d => `${d.source.name} ‚Üî ${d.target.name}\n–°–æ–≤–º–µ—Å—Ç–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫: ${d.synchronous_count}\n–°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: ${d.avg_time_diff}—Å`);
            
            // Update positions on tick with throttling
            let tickCount = 0;
            simulation.on('tick', () => {
                tickCount++;
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –∫–∞–∂–¥—ã–π 3-–π —Ç–∏–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                if (tickCount % 3 === 0) {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                    
                    label
                        .attr('x', d => d.x)
                        .attr('y', d => d.y);
                }
            });
            
            // Drag functions with passive event listeners
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.1).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º passive event listeners –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const drag = d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        // Get node color based on suspicion level
        function getNodeColor(suspicionLevel) {
            switch (suspicionLevel) {
                case '–ö–†–ò–¢–ò–ß–ï–°–ö–ò –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û':
                    return '#dc2626'; // red-600
                case '–ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û':
                    return '#ea580c'; // orange-600
                case '–í–ù–ò–ú–ê–ù–ò–ï':
                    return '#d97706'; // amber-600
                default:
                    return '#6b7280'; // gray-500
            }
        }

        // Get link color based on average time difference
        function getLinkColor(avgTimeDiff) {
            if (avgTimeDiff <= 1) return '#dc2626'; // red - very fast
            if (avgTimeDiff <= 3) return '#ea580c'; // orange - fast
            if (avgTimeDiff <= 5) return '#d97706'; // yellow - medium
            return '#16a34a'; // green - slow
        }

        // Reset graph
        function resetGraph() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
        }

        // Export graph
        function exportGraph() {
            if (svg) {
                const svgData = new XMLSerializer().serializeToString(svg.node());
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const link = document.createElement('a');
                    link.download = 'bot-network-graph.png';
                    link.href = canvas.toDataURL();
                    link.click();
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
            }
        }

        // Show lots for temporal pattern pair
        async function showTemporalPatternLots(group) {
            try {
                console.log('üîç –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ—Ç—ã –¥–ª—è –ø–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', group.users);
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-screen overflow-y-auto w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">–õ–æ—Ç—ã –ø–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${group.users.join(' ‚Üî ')}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="mb-4 text-sm text-gray-600">
                            <p><strong>–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫:</strong> ${group.synchronous_count}</p>
                            <p><strong>–°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª:</strong> ${group.avg_time_diff} —Å–µ–∫</p>
                            <p><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ª–æ—Ç–æ–≤:</strong> ${group.unique_lots}</p>
                            <p><strong>–£—Ä–æ–≤–µ–Ω—å —Ä–∏—Å–∫–∞:</strong> ${group.suspicion_level}</p>
                        </div>
                        <div id="temporal-pattern-lots-container" class="space-y-4">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                                <p class="mt-2 text-gray-600">–ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ—Ç—ã...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ—Ç—ã –¥–ª—è –ø–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const response = await fetch(`/api/analytics/temporal-pattern-lots?user1=${group.users[0]}&user2=${group.users[1]}`);
                const result = await response.json();
                
                if (result.success) {
                    displayTemporalPatternLots(result.data, group);
                } else {
                    document.getElementById('temporal-pattern-lots-container').innerHTML = `
                        <div class="text-center text-red-600">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–æ–≤: ${result.error}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–æ–≤ –¥–ª—è –ø–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–æ–≤');
            }
        }

        // Display lots for temporal pattern pair
        function displayTemporalPatternLots(lots, group) {
            const container = document.getElementById('temporal-pattern-lots-container');
            
            if (lots.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-600">
                        <i class="fas fa-info-circle text-2xl mb-2"></i>
                        <p>–õ–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = lots.map(lot => `
                <div class="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="showLotModal('${lot.lot_id}')">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-lg">–õ–æ—Ç ${lot.lot_id}</h4>
                            <p class="text-sm text-gray-600">–ê—É–∫—Ü–∏–æ–Ω ${lot.auction_number}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-600">${formatPrice(lot.winning_bid)}</p>
                            <p class="text-sm text-gray-500">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${lot.winner_login}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1:</strong> ${lot.user1} (${lot.timestamp1})</p>
                            <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 2:</strong> ${lot.user2} (${lot.timestamp2})</p>
                        </div>
                        <div>
                            <p><strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</strong> ${lot.time_diff_seconds} —Å–µ–∫</p>
                            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${lot.category || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Load suspicious users
        async function loadSuspiciousUsers(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...';
                button.disabled = true;

                const threshold = prompt('–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ —Å–∫–æ—Ä–∏–Ω–≥–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30):', '30') || '30';
                const response = await fetch(`/api/analytics/suspicious-users?threshold=${threshold}`);
                const result = await response.json();
                
                if (result.success) {
                    displaySuspiciousUsers(result.data);
                    document.getElementById('autobid-traps-count').textContent = `–ù–∞–π–¥–µ–Ω–æ ${result.data.length} –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–ø–æ—Ä–æ–≥: ${threshold})`;
                    document.getElementById('autobid-traps-results').classList.remove('hidden');
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            } finally {
                button.innerHTML = '<i class="fas fa-users mr-2"></i>–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏';
                button.disabled = false;
            }
        }

        // Display suspicious users results
        function displaySuspiciousUsers(data) {
            const tbody = document.getElementById('autobid-traps-table-body');
            tbody.innerHTML = '';

            // Update table headers for suspicious users
            const thead = document.querySelector('#autobid-traps-results thead tr');
            thead.innerHTML = `
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–û–±—â–∏–π —Å–∫–æ—Ä–∏–Ω–≥</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ë—ã—Å—Ç—Ä—ã–µ —Å—Ç–∞–≤–∫–∏</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–õ–æ–≤—É—à–∫–∏ –∞–≤—Ç–æ–±–∏–¥–∞</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ú–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–†–µ–π—Ç–∏–Ω–≥</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">–õ–æ—Ç–æ–≤</th>
            `;

            data.forEach(user => {
                const row = document.createElement('tr');
                
                // Suspicious score styling
                let scoreClass = 'text-gray-600';
                let scoreIcon = '';
                if (user.suspicious_score >= 80) {
                    scoreClass = 'text-red-600 font-bold';
                    scoreIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (user.suspicious_score >= 50) {
                    scoreClass = 'text-orange-600 font-semibold';
                    scoreIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (user.suspicious_score >= 30) {
                    scoreClass = 'text-yellow-600 font-medium';
                    scoreIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${user.winner_login}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${scoreClass}">
                        ${scoreIcon}${user.suspicious_score}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold ${user.fast_bids_score > 0 ? 'text-orange-600' : 'text-gray-400'}">${user.fast_bids_score || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold ${user.autobid_traps_score > 0 ? 'text-red-600' : 'text-gray-400'}">${user.autobid_traps_score || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold ${user.manipulation_score > 0 ? 'text-purple-600' : 'text-gray-400'}">${user.manipulation_score || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${user.rating || 'N/A'}</span>
                        <div class="text-xs text-gray-500">${user.category || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${parseFloat(user.total_spent || 0).toLocaleString()} ‚ÇΩ</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${user.total_lots || 0}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–∫–∞–∫ –≤ app.js)
        const elements = {
            lotModal: document.getElementById('lotModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModal: document.getElementById('closeModal')
        };
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ª–æ—Ç–∞ (–¢–û–ß–ù–ê–Ø –∫–æ–ø–∏—è –∏–∑ app.js)
        async function showLotModal(lotId) {
            try {
                const response = await fetch(`/api/lot-details/${lotId}`);
                const lot = await response.json();
                
                elements.modalTitle.innerHTML = `
                    <i class="fas fa-coins text-yellow-500 mr-2"></i>
                    –õ–æ—Ç ${lot.lot_number} (–ê—É–∫—Ü–∏–æ–Ω ${lot.auction_number})
                `;
                
                const imageUrl = lot.avers_image_url || '/placeholder-coin.png';
                const reversImageUrl = lot.revers_image_url || '/placeholder-coin.png';
                
                elements.modalContent.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold mb-4">
                                <i class="fas fa-images text-blue-500 mr-2"></i>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            </h4>
                            <div class="space-y-4">
                                ${lot.avers_image_url ? `
                                    <div>
                                        <p class="text-sm text-gray-600 mb-2">–ê–≤–µ—Ä—Å</p>
                                        <img src="${imageUrl}" alt="–ê–≤–µ—Ä—Å" class="w-full h-64 object-cover rounded-lg border shadow-sm"
                                             onerror="this.src='/placeholder-coin.png'">
                                    </div>
                                ` : ''}
                                ${lot.revers_image_url ? `
                                    <div>
                                        <p class="text-sm text-gray-600 mb-2">–†–µ–≤–µ—Ä—Å</p>
                                        <img src="${reversImageUrl}" alt="–†–µ–≤–µ—Ä—Å" class="w-full h-64 object-cover rounded-lg border shadow-sm"
                                             onerror="this.src='/placeholder-coin.png'">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold mb-4">
                                <i class="fas fa-info-circle text-green-500 mr-2"></i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–æ—Ç–µ
                            </h4>
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-medium text-gray-800 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</h5>
                                    <p class="text-sm text-gray-700 leading-relaxed">${lot.coin_description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-blue-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">–ì–æ–¥</p>
                                        <p class="font-medium text-blue-800">${lot.year || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">–ú–µ—Ç–∞–ª–ª</p>
                                        <p class="font-medium text-green-800">${lot.metal || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                    </div>
                                    <div class="bg-yellow-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">–°–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å</p>
                                        <p class="font-medium text-yellow-800">${lot.condition || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                                    </div>
                                    <div class="bg-purple-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">–ë—É–∫–≤—ã</p>
                                        <p class="font-medium text-purple-800">${lot.letters || '–ù–µ —É–∫–∞–∑–∞–Ω—ã'}</p>
                                    </div>
                                    ${lot.weight ? `
                                        <div class="bg-orange-50 rounded-lg p-3">
                                            <p class="text-sm text-gray-600">–í–µ—Å</p>
                                            <p class="font-medium text-orange-800">${lot.weight}–≥</p>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- –ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞ -->
                                <div id="modal-prediction-${lot.id}" class="mb-4">
                                    <!-- –ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ -->
                                </div>
                                
                                <div class="bg-green-50 rounded-lg p-4">
                                    <h5 class="font-medium text-gray-800 mb-3">
                                        <i class="fas fa-gavel text-green-600 mr-2"></i>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–æ—Ä–≥–æ–≤
                                    </h5>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å:</span>
                                            <div id="modal-winner-${lot.id}" class="font-medium text-green-800"></div>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">–¶–µ–Ω–∞:</span>
                                            <span class="font-bold text-green-600 text-lg">${lot.winning_bid ? formatPrice(lot.winning_bid) : '–ù–µ –ø—Ä–æ–¥–∞–Ω–æ'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–≤–æ–∫:</span>
                                            <span class="font-medium text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="showBidsModal(${lot.id})">${lot.bids_count || 0}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">–°—Ç–∞—Ç—É—Å:</span>
                                            <span class="font-medium text-gray-800">${lot.lot_status || '–ù–µ —É–∫–∞–∑–∞–Ω'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</span>
                                            <span class="font-medium text-gray-800">${lot.auction_end_date ? new Date(lot.auction_end_date).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                                        </div>
                                    </div>
                                    <div id="modal-metal-info-${lot.id}" class="mt-4">
                                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Ç–∞–ª–ª–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ -->
                                    </div>
                                </div>
                                
                                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                                <div class="flex items-center justify-center pt-4 border-t">
                                    <div class="flex space-x-2">
                                        <button onclick="loadPriceHistory(${lot.id})" 
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition-colors text-sm"
                                                title="–ê–Ω–∞–ª–∏–∑ —Ü–µ–Ω—ã">
                                            <i class="fas fa-chart-line"></i>
                                        </button>
                                        <button onclick="addToWatchlist(${lot.id})" 
                                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg transition-colors text-sm"
                                                title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Price History Section (initially hidden) -->
                                <div id="priceHistory-${lot.id}" class="hidden mt-4 pt-4 border-t">
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h5 class="font-semibold text-gray-800 mb-3">
                                            <i class="fas fa-history mr-2"></i>–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –ª–æ—Ç–æ–≤
                                        </h5>
                                        <div id="priceHistoryContent-${lot.id}" class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i>
                                            –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω...
                                        </div>
                                    </div>
                                </div>
                                
                                ${lot.source_url ? `
                                    <div class="border-t pt-4">
                                        <a href="${lot.source_url}" target="_blank" 
                                           class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors">
                                            <i class="fas fa-external-link-alt mr-2"></i>
                                            –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ —Å–∞–π—Ç–µ –∞—É–∫—Ü–∏–æ–Ω–∞
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add clickable winner link in modal
                const modalWinnerContainer = document.querySelector(`#modal-winner-${lot.id}`);
                if (modalWinnerContainer && lot.winner_login) {
                    const winnerLink = createWinnerLink(lot.winner_login);
                    modalWinnerContainer.appendChild(winnerLink);
                } else if (modalWinnerContainer) {
                    modalWinnerContainer.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω';
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ç–∞–ª–ª–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                if (lot.winning_bid && lot.metal && lot.weight) {
                    loadMetalInfo(lot.id).then(metalInfo => {
                        const modalMetalInfoContainer = document.querySelector(`#modal-metal-info-${lot.id}`);
                        if (modalMetalInfoContainer && metalInfo) {
                            modalMetalInfoContainer.innerHTML = createMetalInfoHTML(metalInfo);
                        }
                    });
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑–Ω—É—é —Ü–µ–Ω—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                loadLotPrediction(lot.id);
                
                elements.lotModal.classList.remove('hidden');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ—Ç–∞:', error);
                elements.modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                        <p class="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ª–æ—Ç–∞</p>
                    </div>
                `;
                elements.lotModal.classList.remove('hidden');
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        elements.closeModal.addEventListener('click', () => {
            elements.lotModal.classList.add('hidden');
        });
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        elements.lotModal.addEventListener('click', (e) => {
            if (e.target === elements.lotModal) {
                elements.lotModal.classList.add('hidden');
            }
        });
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ app.js)
        function formatPrice(price) {
            if (!price) return '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }
        
        function createWinnerLink(winnerLogin) {
            if (!winnerLogin) return '–ù–µ —É–∫–∞–∑–∞–Ω';
            
            const container = document.createElement('div');
            container.className = 'flex items-center space-x-2';
            
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'text-blue-600 hover:text-blue-800 hover:underline font-medium';
            link.textContent = winnerLogin;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–∏—Å–∫–∞ –ø–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
                console.log('–ü–æ–∏—Å–∫ –ø–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—é:', winnerLogin);
            });
            
            container.appendChild(link);
            return container;
        }
        
        async function loadMetalInfo(lotId) {
            try {
                const response = await fetch(`/api/numismatic-premium/${lotId}`);
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–µ—Ç–∞–ª–ª–µ:', error);
                return null;
            }
        }
        
        function createMetalInfoHTML(metalInfo) {
            if (!metalInfo) return '';
            
            const { metal_price, numismatic_premium } = metalInfo;
            const metalValue = parseFloat(numismatic_premium.metalValue).toLocaleString('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            });
            const premium = parseFloat(numismatic_premium.premium).toLocaleString('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            });
            const premiumPercent = parseFloat(numismatic_premium.premiumPercent).toFixed(1);
            
            return `
                <div class="bg-blue-50 rounded-lg p-3">
                    <h6 class="font-medium text-blue-800 mb-2">–ê–Ω–∞–ª–∏–∑ –º–µ—Ç–∞–ª–ª–∞</h6>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-blue-700">–°—Ç–æ–∏–º–æ—Å—Ç—å –º–µ—Ç–∞–ª–ª–∞:</span>
                            <span class="font-medium text-blue-800">${metalValue}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">–ù—É–º–∏–∑–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–µ–º–∏—è:</span>
                            <span class="font-medium text-blue-800">${premium} (${premiumPercent}%)</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞–≤–æ–∫ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ app.js)
        async function showBidsModal(lotId) {
            const modal = document.getElementById('bidsModal');
            const loading = document.getElementById('bidsLoading');
            const content = document.getElementById('bidsContent');
            const empty = document.getElementById('bidsEmpty');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            modal.classList.remove('hidden');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            empty.classList.add('hidden');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ç–∞–≤–æ–∫
                const response = await fetch(`/api/lots/${lotId}/bids`);
                const data = await response.json();
                
                if (data.success && data.bids.length > 0) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫–∏
                    displayBids(data.bids);
                    loading.classList.add('hidden');
                    content.classList.remove('hidden');
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞–≤–æ–∫:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function closeBidsModal() {
            document.getElementById('bidsModal').classList.add('hidden');
        }
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Ç–∞–≤–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
        function displayBids(bids) {
            const countElement = document.getElementById('bidsCount');
            const tableBody = document.getElementById('bidsTableBody');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            countElement.textContent = bids.length;
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            tableBody.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–≤–∫–∏
            bids.forEach((bid, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const bidTime = new Date(bid.bid_timestamp).toLocaleString('ru-RU');
                const bidAmount = formatPrice(bid.bid_amount);
                const bidType = bid.is_auto_bid ? 
                    '<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">–ê–≤—Ç–æ–±–∏–¥</span>' :
                    '<span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">–†—É—á–Ω–∞—è</span>';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${bidTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${bid.bidder_login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">${bidAmount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${bidType}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ app.js)
        async function loadLotPrediction(lotId) {
            try {
                const response = await fetch(`/api/prediction/${lotId}`);
                if (!response.ok) {
                    throw new Error('–ü—Ä–æ–≥–Ω–æ–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                const prediction = await response.json();
                displayLotPrediction(lotId, prediction);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–∞:', error);
                // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –ø—Ä–æ–≥–Ω–æ–∑–∞ –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                const predictionElement = document.querySelector(`#modal-prediction-${lotId}`);
                if (predictionElement) {
                    predictionElement.style.display = 'none';
                }
            }
        }
        
        function displayLotPrediction(lotId, prediction) {
            const predictionElement = document.querySelector(`#modal-prediction-${lotId}`);
            if (!predictionElement) {
                return;
            }
            
            // –ï—Å–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞ null (–Ω–µ—Ç –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –ª–æ—Ç–æ–≤), –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (prediction.predicted_price === null) {
                predictionElement.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-question-circle text-gray-500 mr-2"></i>
                                <h5 class="font-semibold text-gray-700">–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞</h5>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö
                            </span>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ª–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω—É–∂–Ω—ã –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –º–æ–Ω–µ—Ç
                            </p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // –ï—Å–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞ —Ä–∞–≤–Ω–∞ 0 –∏–ª–∏ undefined, —Å–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫
            if (!prediction.predicted_price || prediction.predicted_price <= 0) {
                predictionElement.style.display = 'none';
                return;
            }
            
            const predictedPrice = prediction.predicted_price;
            const confidence = Math.round((prediction.confidence_score || 0) * 100);
            const currentBid = prediction.current_bid_amount || prediction.winning_bid || 0;
            
            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –ø—Ä–æ–≥–Ω–æ–∑–æ–º –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ç–µ–∫—É—â–µ–π —Å—Ç–∞–≤–∫–æ–π
            const difference = predictedPrice - currentBid;
            const differencePercent = currentBid > 0 ? Math.round((difference / currentBid) * 100) : 0;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–æ–≤—É—é —Å—Ö–µ–º—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–Ω–æ—Å—Ç–∏
            let bgColor, textColor, iconColor, borderColor;
            if (difference > 0) {
                // –ü—Ä–æ–≥–Ω–æ–∑ –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Å—Ç–∞–≤–∫–∏ - —Ö–æ—Ä–æ—à–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å
                bgColor = 'bg-green-50';
                textColor = 'text-green-800';
                iconColor = 'text-green-600';
                borderColor = 'border-green-200';
            } else if (difference < 0) {
                // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Å—Ç–∞–≤–∫–∏ - –ø–µ—Ä–µ–ø–ª–∞—Ç–∞
                bgColor = 'bg-red-50';
                textColor = 'text-red-800';
                iconColor = 'text-red-600';
                borderColor = 'border-red-200';
            } else {
                // –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞–≤–µ–Ω —Ç–µ–∫—É—â–µ–π —Å—Ç–∞–≤–∫–µ
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-800';
                iconColor = 'text-blue-600';
                borderColor = 'border-blue-200';
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            let confidenceLevel, confidenceText;
            if (confidence >= 80) {
                confidenceLevel = 'bg-green-100 text-green-800';
                confidenceText = '–í—ã—Å–æ–∫–∞—è';
            } else if (confidence >= 60) {
                confidenceLevel = 'bg-yellow-100 text-yellow-800';
                confidenceText = '–°—Ä–µ–¥–Ω—è—è';
            } else {
                confidenceLevel = 'bg-red-100 text-red-800';
                confidenceText = '–ù–∏–∑–∫–∞—è';
            }
            
            predictionElement.innerHTML = `
                <div class="bg-gradient-to-r ${bgColor} border ${borderColor} rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <i class="fas fa-crystal-ball ${iconColor} mr-2"></i>
                            <h5 class="font-semibold ${textColor}">–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞</h5>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${confidenceLevel}">
                                ${confidenceText} (${confidence}%)
                            </span>
                            <span class="text-xs ${textColor}">
                                ${getPredictionMethodText(prediction.prediction_method)}${prediction.sample_size ? ` (${prediction.sample_size})` : ''}
                            </span>
                        </div>
                    </div>
                    
                    ${prediction.prediction_created_at ? `
                        <div class="mb-3 text-center">
                            <p class="text-xs ${textColor} opacity-75">
                                <i class="fas fa-clock mr-1"></i>
                                –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–µ—Ä–∞—Å—á–µ—Ç: ${formatPredictionDate(prediction.prediction_created_at)}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-sm ${textColor} mb-1">–ü—Ä–æ–≥–Ω–æ–∑–Ω–∞—è —Ü–µ–Ω–∞</p>
                            <p class="text-xl font-bold ${textColor}">${formatPrice(predictedPrice)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm ${textColor} mb-1">–†–∞–∑–Ω–æ—Å—Ç—å</p>
                            <div class="flex items-center justify-center">
                                <i class="fas ${difference > 0 ? 'fa-arrow-up' : difference < 0 ? 'fa-arrow-down' : 'fa-minus'} ${iconColor} mr-1"></i>
                                <span class="text-lg font-bold ${textColor}">
                                    ${difference > 0 ? '+' : ''}${formatPrice(Math.abs(difference))}
                                </span>
                            </div>
                            <p class="text-xs ${textColor}">
                                ${differencePercent > 0 ? '+' : ''}${differencePercent}%
                            </p>
                        </div>
                    </div>
                    
                    ${prediction.metal_value > 0 ? `
                        <div class="mt-3 pt-3 border-t ${borderColor}">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="text-center">
                                    <p class="${textColor} mb-1">–°—Ç–æ–∏–º–æ—Å—Ç—å –º–µ—Ç–∞–ª–ª–∞</p>
                                    <p class="font-semibold ${textColor}">${formatPrice(prediction.metal_value)}</p>
                                </div>
                                <div class="text-center">
                                    <p class="${textColor} mb-1">–ù—É–º–∏–∑–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Ü–µ–Ω–∫–∞</p>
                                    <p class="font-semibold ${textColor}">${formatPrice(prediction.numismatic_premium)}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-3 pt-3 border-t ${borderColor}">
                        <p class="text-xs ${textColor} text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            –ü—Ä–æ–≥–Ω–æ–∑ –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã—Ö –ª–æ—Ç–æ–≤
                        </p>
                    </div>
                </div>
            `;
        }
        
        function getPredictionMethodText(method) {
            const methodTexts = {
                'no_similar_lots': '–ù–µ—Ç –∞–Ω–∞–ª–æ–≥–æ–≤',
                'single_similar_lot': '1 –∞–Ω–∞–ª–æ–≥',
                'statistical_model': '–°—Ç–∞—Ç. –º–æ–¥–µ–ª—å',
                'calibrated': '–ö–∞–ª–∏–±—Ä–æ–≤–∞–Ω–Ω–∞—è',
                'simple': '–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è',
                'simplified_model': '–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è'
            };
            return methodTexts[method] || method || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
        
        function formatPredictionDate(dateString) {
            if (!dateString) return '–ù–µ —É–∫–∞–∑–∞–Ω–∞';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            if (diffMinutes < 60) {
                return `${diffMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            } else if (diffHours < 24) {
                return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            } else if (diffDays < 7) {
                return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
            } else {
                return date.toLocaleDateString('ru-RU');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ app.js)
        async function loadPriceHistory(lotId) {
            const priceHistorySection = document.querySelector(`#priceHistory-${lotId}`);
            const priceHistoryContent = document.querySelector(`#priceHistoryContent-${lotId}`);
            
            // Toggle visibility
            if (priceHistorySection.classList.contains('hidden')) {
                priceHistorySection.classList.remove('hidden');
                
                // Load price history if not already loaded
                if (priceHistoryContent.innerHTML.includes('–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω')) {
                    try {
                        const response = await fetch(`/api/similar-lots/${lotId}`);
                        const data = await response.json();
                        
                        displayPriceHistory(lotId, data);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω:', error);
                        priceHistoryContent.innerHTML = `
                            <div class="text-red-600">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω
                            </div>
                        `;
                    }
                }
            } else {
                priceHistorySection.classList.add('hidden');
            }
        }
        
        function displayPriceHistory(lotId, data) {
            const priceHistoryContent = document.querySelector(`#priceHistoryContent-${lotId}`);
            const { currentLot, similarLots } = data;
            
            if (similarLots.length === 0) {
                priceHistoryContent.innerHTML = `
                    <div class="text-gray-600">
                        <i class="fas fa-info-circle mr-2"></i>
                        –ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ª–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                    </div>
                `;
                return;
            }
            
            // Calculate price statistics
            const prices = similarLots.map(lot => lot.winning_bid);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            
            let historyHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <p class="text-sm text-gray-600">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞</p>
                        <p class="text-lg font-bold text-green-600">${formatPrice(minPrice)}</p>
                    </div>
                    <div class="bg-red-50 rounded-lg p-3 text-center">
                        <p class="text-sm text-gray-600">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞</p>
                        <p class="text-lg font-bold text-red-600">${formatPrice(maxPrice)}</p>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <h6 class="font-medium text-gray-800 mb-2">–ê–Ω–∞–ª–æ–≥–∏—á–Ω—ã–µ –ª–æ—Ç—ã:</h6>
            `;
            
            similarLots.slice(0, 5).forEach(lot => {
                historyHTML += `
                    <div class="py-2 px-3 bg-white rounded border cursor-pointer hover:bg-gray-50 transition-colors" 
                         onclick="showLotModal(${lot.id})">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium">–õ–æ—Ç ${lot.lot_number} (–ê—É–∫—Ü–∏–æ–Ω ${lot.auction_number})</p>
                                <p class="text-xs text-gray-500">${lot.year}–≥. ‚Ä¢ ${lot.metal} ‚Ä¢ ${lot.condition}${lot.weight ? ` ‚Ä¢ ${lot.weight}–≥` : ''}</p>
                                <p class="text-xs text-gray-500">${formatPredictionDate(lot.auction_end_date)}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-600">${formatPrice(lot.winning_bid)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyHTML += '</div>';
            priceHistoryContent.innerHTML = historyHTML;
        }
        
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è addToWatchlist (–º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ)
        function addToWatchlist(lotId) {
            console.log('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:', lotId);
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        }

        // Initialize page
        loadStats();
    </script>
</body>
</html>
