<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аналитика подозрительных ставок - Wolmar Parser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Аналитика подозрительных ставок</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-home mr-2"></i>Главная
                    </a>
                    <a href="/admin" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-cog mr-2"></i>Админка
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <i class="fas fa-gavel text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Всего ставок</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-bids">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <i class="fas fa-users text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Участников</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-bidders">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <i class="fas fa-hand-paper text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Ручных ставок</p>
                        <p class="text-2xl font-bold text-gray-900" id="manual-bids">-</p>
                        <p class="text-xs text-gray-500" id="manual-percentage">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-sm p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <i class="fas fa-exclamation-triangle text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Подозрительных</p>
                        <p class="text-2xl font-bold text-gray-900" id="suspicious-users">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Tabs -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6 px-4 overflow-x-auto" aria-label="Tabs">
                    <button onclick="showTab('fast-bids')" id="tab-fast-bids" class="tab-button active border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-bolt mr-2"></i>Быстрые ставки
                    </button>
                    <button onclick="showTab('autobid-traps')" id="tab-autobid-traps" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-mouse-pointer mr-2"></i>Ловушки автобида
                    </button>
                    <button onclick="showTab('time-patterns')" id="tab-time-patterns" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-clock mr-2"></i>Временные паттерны
                    </button>
                    <button onclick="showTab('risk-scoring')" id="tab-risk-scoring" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Скоринг рисков
                    </button>
                    <button onclick="showTab('circular-buyers')" id="tab-circular-buyers" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-sync-alt mr-2"></i>Круговые покупки
                    </button>
                    <button onclick="showTab('linked-accounts')" id="tab-linked-accounts" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-link mr-2"></i>Связанные аккаунты
                    </button>
                    <button onclick="showTab('carousel-analysis')" id="tab-carousel-analysis" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-carousel mr-2"></i>Карусель перепродаж
                    </button>
                    <button onclick="showTab('abandonment-analysis')" id="tab-abandonment-analysis" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-stop mr-2"></i>Замирание торгов
                    </button>
                    <button onclick="showTab('autobid-probing')" id="tab-autobid-probing" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-user-secret mr-2"></i>Саморазгон/Самовыкуп
                    </button>
                    <button onclick="showTab('pricing-strategies')" id="tab-pricing-strategies" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-chart-line mr-2"></i>Стратегии разгона
                    </button>
                    <button onclick="showTab('decoy-tactics')" id="tab-decoy-tactics" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-bait mr-2"></i>Тактики приманки
                    </button>
                    <button onclick="showTab('technical-bidders')" id="tab-technical-bidders" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                        <i class="fas fa-user-cog mr-2"></i>Технические пользователи
                    </button>
                </nav>
            </div>

            <!-- Fast Bids Tab Content -->
            <div id="content-fast-bids" class="tab-content p-6">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Анализ быстрых ручных ставок</h3>
                    <p class="text-gray-600 mb-4">Поиск ручных ставок с подозрительно малыми интервалами времени</p>
                    <button onclick="loadFastBids(event)" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-search mr-2"></i>Загрузить анализ
                    </button>
                </div>
                
                <div id="fast-bids-results" class="hidden">
                    <div class="mb-4">
                        <span id="fast-bids-count" class="text-sm text-gray-600"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Участник</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Всего подозрительных</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Критических (< 1 сек)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Подозрительных (< 5 сек)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Быстрейший интервал</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Средний интервал</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Уровень риска</th>
                                </tr>
                            </thead>
                            <tbody id="fast-bids-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Autobid Traps Tab Content -->
            <div id="content-autobid-traps" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Анализ ловушек автобида</h3>
                    <p class="text-gray-600 mb-4">Поиск лотов с подозрительной активностью, где победитель использовал автобид</p>
                    <button onclick="loadAutobidTraps(event)" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                        <i class="fas fa-search mr-2"></i>Загрузить анализ
                    </button>
                    <button onclick="loadSuspiciousUsers(event)" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 ml-2">
                        <i class="fas fa-users mr-2"></i>Подозрительные пользователи
                    </button>
                </div>
                
                <div id="autobid-traps-results" class="hidden">
                    <div class="mb-4">
                        <span id="autobid-traps-count" class="text-sm text-gray-600"></span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Аукцион/Лот</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Победитель</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Финальная цена</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Прогнозная цена</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Рост от прогноза</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ставок</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Участников</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Уровень риска</th>
                                </tr>
                            </thead>
                            <tbody id="autobid-traps-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="content-time-patterns" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Анализ временных паттернов</h3>
                    <p class="text-gray-600 mb-4">Поиск синхронных ставок подозрительных пользователей (потенциальные бот-сети)</p>
                    <button onclick="loadTemporalPatterns(event)" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-search mr-2"></i>Загрузить анализ
                    </button>
                </div>
                
                <div id="temporal-patterns-results" class="hidden">
                    <div class="mb-4 flex justify-between items-center">
                        <span id="temporal-patterns-count" class="text-sm text-gray-600"></span>
                        <div class="flex space-x-2">
                            <button onclick="toggleView('table')" id="table-view-btn" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                <i class="fas fa-table mr-1"></i>Таблица
                            </button>
                            <button onclick="toggleView('graph')" id="graph-view-btn" class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm">
                                <i class="fas fa-project-diagram mr-1"></i>Граф
                            </button>
                        </div>
                    </div>
                    
                    <!-- Табличное представление -->
                    <div id="table-view" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пользователи</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Синхронных ставок</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Средний интервал</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Уникальных лотов</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Уровень риска</th>
                                </tr>
                            </thead>
                            <tbody id="temporal-patterns-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Графовое представление -->
                    <div id="graph-view" class="hidden">
                        <div class="bg-white rounded-lg border p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-semibold">Граф бот-сетей</h4>
                           <div class="flex space-x-2">
                               <button onclick="resetGraph()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm">
                                   <i class="fas fa-undo mr-1"></i>Сброс
                               </button>
                               <button onclick="unlockAllNodes()" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">
                                   <i class="fas fa-unlock mr-1"></i>Разблокировать
                               </button>
                               <button onclick="exportGraph()" class="px-3 py-1 bg-green-500 text-white rounded text-sm">
                                   <i class="fas fa-download mr-1"></i>Экспорт
                               </button>
                           </div>
                            </div>
                            
                            <!-- Панель фильтров -->
                            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="text-sm font-medium text-gray-700">Фильтр узлов по подозрительности:</h5>
                                    <span id="visible-nodes-count" class="text-xs text-gray-500">Видимых узлов: 0</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="filter-critical" checked class="mr-1" onchange="filterNodes()">
                                        <span class="text-xs">🔴 Критически подозрительно</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="filter-suspicious" checked class="mr-1" onchange="filterNodes()">
                                        <span class="text-xs">🟠 Подозрительно</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="filter-warning" checked class="mr-1" onchange="filterNodes()">
                                        <span class="text-xs">🟡 Внимание</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="filter-normal" class="mr-1" onchange="filterNodes()">
                                        <span class="text-xs">🟢 Норма</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="filter-unknown" class="mr-1" onchange="filterNodes()">
                                        <span class="text-xs">⚫ Неизвестно</span>
                                    </label>
                                    <button onclick="selectAllFilters()" class="px-2 py-1 bg-gray-300 text-gray-700 rounded text-xs">
                                        Все
                                    </button>
                                    <button onclick="selectNoneFilters()" class="px-2 py-1 bg-gray-300 text-gray-700 rounded text-xs">
                                        Ничего
                                    </button>
                                    <button onclick="showOnlyCritical()" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">
                                        Только 🔴
                                    </button>
                                    <button onclick="showOnlySuspicious()" class="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs">
                                        Только 🟠
                                    </button>
                                </div>
                                
                                <!-- Дополнительные фильтры -->
                                <div class="mt-3 pt-3 border-t border-gray-200">
                                    <h6 class="text-xs font-medium text-gray-600 mb-2">Дополнительные фильтры:</h6>
                                    <div class="flex flex-wrap gap-2 items-center">
                                        <label class="flex items-center">
                                            <span class="text-xs text-gray-600 mr-2">Минимум связей:</span>
                                            <input type="number" id="min-connections" min="1" max="50" value="1" 
                                                   class="w-16 px-2 py-1 text-xs border rounded" onchange="filterByConnections()">
                                        </label>
                                        <button onclick="showMostConnected()" class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">
                                            Самые связанные
                                        </button>
                                        <button onclick="resetConnectionFilter()" class="px-2 py-1 bg-gray-200 text-gray-600 rounded text-xs">
                                            Сброс
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="graph-container" class="w-full border rounded" style="height: 600px;"></div>
                            
                            <!-- Легенда -->
                            <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">Размер узлов</h5>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
                                            <span>Количество синхронных событий</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">Цвет узлов</h5>
                                    <div class="flex items-center space-x-4 text-sm flex-wrap">
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                                            <span>Критически подозрительно</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                                            <span>Подозрительно</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                                            <span>Внимание</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                            <span>Норма</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-3 h-3 bg-gray-500 rounded-full mr-2"></div>
                                            <span>Неизвестно</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">Толщина связей</h5>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-8 h-1 bg-gray-400 mr-2"></div>
                                            <span>Количество совместных ставок</span>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h5 class="font-medium text-gray-800 mb-2">Цвет связей</h5>
                                    <div class="flex items-center space-x-4 text-sm">
                                        <div class="flex items-center">
                                            <div class="w-4 h-1 bg-red-500 mr-2"></div>
                                            <span>≤1 сек</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-4 h-1 bg-orange-500 mr-2"></div>
                                            <span>≤3 сек</span>
                                        </div>
                                        <div class="flex items-center">
                                            <div class="w-4 h-1 bg-yellow-500 mr-2"></div>
                                            <span>≤5 сек</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="content-risk-scoring" class="tab-content p-6 hidden">
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Скоринг рисков</h3>
                <p class="text-gray-600">Функция в разработке...</p>
            </div>

            <!-- Circular Buyers Tab Content -->
            <div id="content-circular-buyers" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Круговые покупки (Гипотеза 1)</h3>
                    <p class="text-gray-600 mb-4">Анализ пользователей, покупающих одинаковые монеты многократно - возможные фиктивные покупатели</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadCircularBuyers()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. покупок:</label>
                            <input type="number" id="circularMinPurchases" value="3" min="2" max="10" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Месяцев:</label>
                            <input type="number" id="circularMonths" value="6" min="1" max="12" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                <div id="circular-buyers-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пользователь</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Монета</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Покупок</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Средняя цена</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Конкуренция</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Индекс подозрительности</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="circular-buyers-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Linked Accounts Tab Content -->
            <div id="content-linked-accounts" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Связанные аккаунты (Гипотеза 2)</h3>
                    <p class="text-gray-600 mb-4">Поиск аккаунтов с похожими паттернами поведения - возможные множественные аккаунты одного человека</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadLinkedAccounts()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Порог похожести:</label>
                            <input type="number" id="linkedSimilarityThreshold" value="0.80" min="0.5" max="1.0" step="0.05" class="w-20 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. ставок:</label>
                            <input type="number" id="linkedMinBids" value="10" min="5" max="50" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                <div id="linked-accounts-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Аккаунт 1</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Аккаунт 2</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Похожесть</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Временная похожесть</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Автобиды</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="linked-accounts-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Граф связей связанных аккаунтов -->
                    <div class="mt-6">
                        <div class="mb-3 flex justify-between items-center">
                            <h4 class="text-lg font-semibold">Граф связанных аккаунтов</h4>
                            <div class="flex space-x-2">
                                <button onclick="renderLinkedAccountsGraph(window._lastLinkedAccountsPairs || [])" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                    <i class="fas fa-project-diagram mr-1"></i>Построить граф
                                </button>
                                <button onclick="resetLinkedGraph()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm">
                                    <i class="fas fa-undo mr-1"></i>Сброс
                                </button>
                            </div>
                        </div>
                        <div id="linked-graph-container" class="w-full border rounded" style="height: 600px;"></div>
                    </div>
                </div>
            </div>

            <!-- Carousel Analysis Tab Content -->
            <div id="content-carousel-analysis" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Карусель перепродаж (Гипотеза 8)</h3>
                    <p class="text-gray-600 mb-4">Анализ монет, которые ходят по кругу между одними и теми же участниками</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadCarouselAnalysis()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. продаж:</label>
                            <input type="number" id="carouselMinSales" value="3" min="2" max="10" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Макс. недель:</label>
                            <input type="number" id="carouselMaxWeeks" value="4" min="1" max="12" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Месяцев:</label>
                            <input type="number" id="carouselMonths" value="3" min="1" max="12" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Лимит монет:</label>
                            <input type="number" id="carouselLimit" value="1000" min="100" max="10000" step="100" class="w-24 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                <div id="carousel-analysis-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Монета</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Продаж</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Участников</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Период (нед.)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Рост цены %</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Индекс карусели</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="carousel-analysis-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Abandonment Analysis Tab Content -->
            <div id="content-abandonment-analysis" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Замирание торгов (Гипотеза 3)</h3>
                    <p class="text-gray-600 mb-4">Анализ лотов с резким замиранием активности торгов — возможные манипуляции</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadAbandonmentAnalysis()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. ставок:</label>
                            <input type="number" id="abandonmentMinBids" value="5" min="3" max="20" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Макс. секунд:</label>
                            <input id="abandonmentMaxSeconds" value="18000" class="w-28 px-2 py-1 border rounded text-sm" placeholder="18000">
                        </div>
                    </div>
                </div>
                <div id="abandonment-analysis-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Лот</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Победитель</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ставок</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Макс. пауза (ч)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Множитель цены</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Паттерны</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="abandonment-analysis-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Self-Boost / Self-Buy Tab Content -->
            <div id="content-autobid-probing" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Саморазгон/Самовыкуп (Новая гипотеза)</h3>
                    <p class="text-gray-600 mb-4">Поиск случаев, когда победитель последовательно повышает собственные ручные ставки без конкурентов, приводя к завышенной цене</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadSelfBoostAnalysis()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. подряд:</label>
                            <input type="number" id="selfBoostMinConsecutive" value="3" min="2" max="10" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. доля (0–1):</label>
                            <input type="number" step="0.05" id="selfBoostMinShare" value="0.6" min="0.1" max="1.0" class="w-20 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Макс. участников:</label>
                            <input type="number" id="selfBoostMaxUnique" value="2" min="1" max="5" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Месяцев:</label>
                            <input type="number" id="selfBoostMonths" value="6" min="1" max="12" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                <div id="self-boost-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Лот</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Победитель</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ставок</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Подряд само-повыш.</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Само-повыш. %</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Уникальных участников</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Паттерны</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="self-boost-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Strategies Tab Content -->
            <div id="content-pricing-strategies" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Стратегии разгона цен (Гипотеза 5)</h3>
                    <p class="text-gray-600 mb-4">Анализ лотов с высоким разгоном цен - стратегии "Группа А" и "Группа Б"</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadPricingStrategies()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. ставок:</label>
                            <input type="number" id="pricingMinBids" value="5" min="3" max="20" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. множитель:</label>
                            <input type="number" id="pricingMinMultiplier" value="2.0" min="1.0" max="10.0" step="0.1" class="w-20 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                <div id="pricing-strategies-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Лот</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Победитель</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Множитель</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ставок</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Быстрых %</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Стратегия</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="pricing-strategies-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Decoy Tactics Tab Content -->
            <div id="content-decoy-tactics" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Тактики приманки (Гипотеза 7)</h3>
                    <p class="text-gray-600 mb-4">Анализ пользователей с подозрительными паттернами покупок - дешевые + дорогие</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadDecoyTactics()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. лотов:</label>
                            <input type="number" id="decoyMinLots" value="3" min="2" max="20" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Макс. разница %:</label>
                            <input type="number" id="decoyMaxPriceDiff" value="0.5" min="0.1" max="2.0" step="0.1" class="w-20 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                <div id="decoy-tactics-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пользователь</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Покупок</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Диапазон цен</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Высокие множители %</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Быстрых покупок %</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тактика</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="decoy-tactics-table" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technical Bidders Tab Content -->
            <div id="content-technical-bidders" class="tab-content p-6 hidden">
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Технические пользователи</h3>
                    <p class="text-gray-600 mb-4">Пользователи с большим числом ручных ставок и нулем побед за период</p>
                    <div class="flex space-x-4 mb-4">
                        <button onclick="loadTechnicalBidders()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            <i class="fas fa-play mr-2"></i>Запустить анализ
                        </button>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Мин. ручных ставок:</label>
                            <input type="number" id="technicalMinBids" value="20" min="5" max="500" class="w-20 px-2 py-1 border rounded text-sm">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600">Месяцев:</label>
                            <input type="number" id="technicalMonths" value="6" min="1" max="12" class="w-16 px-2 py-1 border rounded text-sm">
                        </div>
                    </div>
                </div>
                <div id="technical-bidders-results" class="hidden">
                    <div class="bg-white rounded-lg shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пользователь</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ручных</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Авто</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Всего</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Лотов</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Быстрых ручных %</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Побед</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Риск</th>
                                    </tr>
                                </thead>
                                <tbody id="technical-bidders-table" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal для карточки лота (скопировано из index.html) -->
    <div id="lotModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Детали лота</h3>
                        <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="modalContent">
                        <!-- Modal content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Детали карусели перепродаж -->
    <div id="carousel-details-modal" class="fixed inset-0 bg-black bg-opacity-30 hidden z-50">
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between border-b px-4 py-3 sticky top-0 bg-white z-10">
                    <h3 id="carousel-details-title" class="text-lg font-semibold">Детали карусели</h3>
                    <button onclick="closeCarouselModal()" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-4 space-y-4 overflow-y-auto" style="max-height: calc(90vh - 110px);">
                    <!-- Timeline -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Таймлайн продаж</h4>
                        <div id="carousel-timeline" class="w-full border rounded" style="height: 160px;"></div>
                    </div>
                    <!-- Graph -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Граф участников</h4>
                        <div id="carousel-graph" class="w-full border rounded" style="height: 360px;"></div>
                    </div>
                    <!-- Table -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Список продаж и участники</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Аукцион</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Победитель</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Цена</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Участники (топ)</th>
                                    </tr>
                                </thead>
                                <tbody id="carousel-details-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="border-t px-4 py-3 flex justify-end">
                    <button onclick="closeCarouselModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded">Закрыть</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal для истории ставок (скопировано из index.html) -->
    <div id="bidsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="flex items-center justify-between p-6 border-b">
                    <h3 class="text-xl font-semibold text-gray-800">История ставок</h3>
                    <button onclick="closeBidsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                    <div id="bidsLoading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                        <p class="mt-2 text-gray-600">Загрузка истории ставок...</p>
                    </div>
                    <div id="bidsContent" class="hidden">
                        <div id="bidsSummary" class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Всего ставок:</span>
                                <span id="bidsCount" class="font-semibold text-gray-800"></span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Время</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Участник</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Сумма</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тип</th>
                                    </tr>
                                </thead>
                                <tbody id="bidsTableBody" class="divide-y divide-gray-200">
                                    <!-- Bids will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="bidsEmpty" class="text-center py-8 hidden">
                            <i class="fas fa-gavel text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">История ставок недоступна</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeButton = document.getElementById(`tab-${tabName}`);
            activeButton.classList.add('active', 'border-blue-500', 'text-blue-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
        }

        // Load dashboard stats
        async function loadStats() {
            try {
                const response = await fetch('/api/analytics/dashboard-stats');
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('total-bids').textContent = result.data.totalBids.toLocaleString();
                    document.getElementById('total-bidders').textContent = result.data.totalBidders.toLocaleString();
                    document.getElementById('manual-bids').textContent = result.data.manualBids.toLocaleString();
                    document.getElementById('manual-percentage').textContent = `${result.data.manualBidPercentage}% от всех ставок`;
                }
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }

        // Load fast manual bids analysis
        async function loadFastBids(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Загрузка...';
                button.disabled = true;

                const response = await fetch('/api/analytics/fast-manual-bids');
                const result = await response.json();
                
                if (result.success) {
                    displayFastBids(result.data);
                    document.getElementById('fast-bids-count').textContent = `Найдено ${result.data.length} подозрительных пользователей`;
                    document.getElementById('fast-bids-results').classList.remove('hidden');
                } else {
                    if (result.error === 'Анализ невозможен') {
                        alert(result.message);
                    } else {
                        alert('Ошибка загрузки данных: ' + result.error);
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки быстрых ставок:', error);
                alert('Ошибка загрузки данных');
            } finally {
                button.innerHTML = '<i class="fas fa-search mr-2"></i>Загрузить анализ';
                button.disabled = false;
            }
        }

        // Display fast bids results
        function displayFastBids(data) {
            const tbody = document.getElementById('fast-bids-table-body');
            tbody.innerHTML = '';

            data.forEach(user => {
                const row = document.createElement('tr');
                
                // Risk level styling
                let riskClass = 'text-gray-600';
                let riskIcon = '';
                if (user.risk_level === 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО') {
                    riskClass = 'text-red-600 font-semibold';
                    riskIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (user.risk_level === 'ПОДОЗРИТЕЛЬНО') {
                    riskClass = 'text-orange-600 font-medium';
                    riskIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (user.risk_level === 'ВНИМАНИЕ') {
                    riskClass = 'text-yellow-600';
                    riskIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                } else {
                    riskClass = 'text-green-600';
                    riskIcon = '<i class="fas fa-check-circle text-green-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${user.bidder_login}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${user.suspicious_bids_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold text-red-600">${user.critical_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold text-orange-600">${user.suspicious_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-mono">${parseFloat(user.fastest_interval).toFixed(2)} сек</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="font-mono">${user.avg_interval} сек</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${riskClass}">
                        ${riskIcon}${user.risk_level}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load autobid traps analysis
        async function loadAutobidTraps(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Анализ и обновление...';
                button.disabled = true;

                const response = await fetch('/api/analytics/autobid-traps');
                const result = await response.json();
                
                if (result.success) {
                    displayAutobidTraps(result.data);
                    document.getElementById('autobid-traps-count').textContent = `Найдено ${result.data.length} подозрительных лотов`;
                    document.getElementById('autobid-traps-results').classList.remove('hidden');
                    
                    // Показываем уведомление об успешном обновлении
                    if (result.updated_users) {
                        alert(`✅ Анализ завершен успешно!\n\n📊 Результаты:\n- Найдено ловушек автобида: ${result.data.length}\n- Обновлено пользователей: ${result.updated_users}\n- Обновлен скоринг в базе данных`);
                    }
                } else {
                    alert('Ошибка загрузки данных: ' + result.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки ловушек автобида:', error);
                alert('Ошибка загрузки данных');
            } finally {
                button.innerHTML = '<i class="fas fa-search mr-2"></i>Загрузить анализ';
                button.disabled = false;
            }
        }

        // Display autobid traps results
        function displayAutobidTraps(data) {
            const tbody = document.getElementById('autobid-traps-table-body');
            tbody.innerHTML = '';

            data.forEach(lot => {
                const row = document.createElement('tr');
                
                // Risk level styling
                let riskClass = 'text-gray-600';
                let riskIcon = '';
                if (lot.risk_level === 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО') {
                    riskClass = 'text-red-600 font-semibold';
                    riskIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (lot.risk_level === 'ПОДОЗРИТЕЛЬНО') {
                    riskClass = 'text-orange-600 font-medium';
                    riskIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (lot.risk_level === 'ВНИМАНИЕ') {
                    riskClass = 'text-yellow-600';
                    riskIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <span class="text-blue-600 hover:text-blue-800 cursor-pointer" onclick="showLotModal(${lot.lot_id})">
                            ${lot.auction_number}/${lot.lot_number}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${lot.winner_login}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${parseFloat(lot.winning_bid).toLocaleString()} ₽
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${lot.predicted_price ? parseFloat(lot.predicted_price).toLocaleString() + ' ₽' : 'N/A'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-mono font-semibold ${lot.predicted_price_multiplier >= 2.0 ? 'text-red-600' : lot.predicted_price_multiplier >= 1.5 ? 'text-orange-600' : 'text-gray-600'}">
                            ${lot.predicted_price_multiplier ? lot.predicted_price_multiplier + 'x' : 'N/A'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${lot.total_bids}</span>
                        <div class="text-xs text-gray-500">
                            ${lot.manual_bid_count} ручных, ${lot.autobid_count} автобидов
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${lot.unique_bidders}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${riskClass}">
                        ${riskIcon}${lot.risk_level}
                    </td>
                `;
                
                // Добавляем hover эффект для всей строки
                row.classList.add('hover:bg-gray-50', 'cursor-pointer');
                row.onclick = () => showLotModal(lot.lot_id);
                tbody.appendChild(row);
            });
        }
        

        // Load temporal patterns analysis
        async function loadTemporalPatterns(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Анализ...';
                button.disabled = true;

                const response = await fetch('/api/analytics/temporal-patterns');
                const result = await response.json();
                
                if (result.success) {
                    // Save graph data for later use
                    currentGraphData = result.graphData;
                    
                    displayTemporalPatterns(result.data);
                    document.getElementById('temporal-patterns-count').textContent = `Найдено ${result.data.length} групп синхронных пользователей`;
                    document.getElementById('temporal-patterns-results').classList.remove('hidden');
                } else {
                    alert('Ошибка загрузки данных: ' + result.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки временных паттернов:', error);
                alert('Ошибка загрузки данных');
            } finally {
                button.innerHTML = '<i class="fas fa-search mr-2"></i>Загрузить анализ';
                button.disabled = false;
            }
        }

        // Display temporal patterns results
        function displayTemporalPatterns(data) {
            const tbody = document.getElementById('temporal-patterns-table-body');
            tbody.innerHTML = '';

            // Сортируем по количеству уникальных лотов (по убыванию)
            data.sort((a, b) => b.unique_lots - a.unique_lots);

            data.forEach(group => {
                const row = document.createElement('tr');
                
                // Risk level styling
                let riskClass = 'text-gray-600';
                let riskIcon = '';
                if (group.suspicion_level === 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО') {
                    riskClass = 'text-red-600 font-semibold';
                    riskIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (group.suspicion_level === 'ПОДОЗРИТЕЛЬНО') {
                    riskClass = 'text-orange-600 font-medium';
                    riskIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (group.suspicion_level === 'ВНИМАНИЕ') {
                    riskClass = 'text-yellow-600';
                    riskIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                } else {
                    riskClass = 'text-green-600';
                    riskIcon = '<i class="fas fa-check-circle text-green-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <div class="flex flex-wrap gap-1">
                            ${group.users.map(user => `
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${user}
                                </span>
                            `).join('')}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${group.synchronous_count}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-mono">${group.avg_time_diff} сек</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${group.unique_lots}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${riskClass}">
                        ${riskIcon}${group.suspicion_level}
                    </td>
                `;
                
                // Делаем строку кликабельной
                row.style.cursor = 'pointer';
                row.classList.add('hover:bg-gray-50');
                row.onclick = () => showTemporalPatternLots(group);
                tbody.appendChild(row);
            });
        }

        // Global variables for graph
        let currentGraphData = null;
        let svg = null;
        let simulation = null;

        // Toggle between table and graph view
        function toggleView(view) {
            const tableView = document.getElementById('table-view');
            const graphView = document.getElementById('graph-view');
            const tableBtn = document.getElementById('table-view-btn');
            const graphBtn = document.getElementById('graph-view-btn');

            if (view === 'table') {
                tableView.classList.remove('hidden');
                graphView.classList.add('hidden');
                tableBtn.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm';
                graphBtn.className = 'px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm';
            } else {
                tableView.classList.add('hidden');
                graphView.classList.remove('hidden');
                tableBtn.className = 'px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm';
                graphBtn.className = 'px-3 py-1 bg-blue-600 text-white rounded text-sm';
                
                // Initialize graph if data is available
                if (currentGraphData) {
                    createGraph(currentGraphData);
                }
            }
        }

        // Create D3.js graph
        function createGraph(graphData) {
            const container = document.getElementById('graph-container');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Create SVG
            svg = d3.select('#graph-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(d3.zoom()
                    .filter(event => !event.button) // Только левая кнопка мыши
                    .on('zoom', (event) => {
                        g.attr('transform', event.transform);
                    }));
            
            const g = svg.append('g');
            
            // Create force simulation with optimized settings
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => Math.sqrt(d.totalSynchronousBids) * 2 + 8))
                .alphaDecay(0.05) // Быстрее затухание
                .velocityDecay(0.3); // Больше сопротивление
            
            // Create links
            const link = g.append('g')
                .selectAll('line')
                .data(graphData.links)
                .enter().append('line')
                .attr('stroke', d => getLinkColor(d.avg_time_diff))
                .attr('stroke-width', d => Math.log(d.synchronous_count) * 2)
                .attr('stroke-opacity', 0.8);
            
            // Create nodes
            const node = g.append('g')
                .selectAll('circle')
                .data(graphData.nodes)
                .enter().append('circle')
                .attr('r', d => Math.sqrt(d.totalSynchronousBids) * 3)
                .attr('fill', d => getNodeColor(d.suspicionLevel))
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // Add labels
            const label = g.append('g')
                .selectAll('text')
                .data(graphData.nodes)
                .enter().append('text')
                .text(d => d.name)
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', '#333');
            
            // Add tooltips
            node.append('title')
                .text(d => `${d.name}\nСинхронных событий: ${d.totalSynchronousBids}\nУровень: ${d.suspicionLevel}`);
            
            link.append('title')
                .text(d => `${d.source.name} ↔ ${d.target.name}\nСовместных ставок: ${d.synchronous_count}\nСредний интервал: ${d.avg_time_diff}с`);
            
            // Инициализируем счетчик видимых узлов
            updateVisibleNodesCount();
            
            // Update positions on tick with throttling
            let tickCount = 0;
            simulation.on('tick', () => {
                tickCount++;
                // Обновляем позиции только каждый 3-й тик для производительности
                if (tickCount % 3 === 0) {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                    
                    label
                        .attr('x', d => d.x)
                        .attr('y', d => d.y);
                }
            });
            
            // Drag functions with passive event listeners
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.1).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // Добавляем passive event listeners для лучшей производительности
            const drag = d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        // Get node color based on suspicion level
        function getNodeColor(suspicionLevel) {
            switch (suspicionLevel) {
                case 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО':
                    return '#dc2626'; // red-600
                case 'ПОДОЗРИТЕЛЬНО':
                    return '#ea580c'; // orange-600
                case 'ВНИМАНИЕ':
                    return '#d97706'; // amber-600
                case 'НОРМА':
                    return '#16a34a'; // green-600
                default:
                    return '#6b7280'; // gray-500 (неизвестный уровень)
            }
        }

        // Get link color based on average time difference
        function getLinkColor(avgTimeDiff) {
            if (avgTimeDiff <= 1) return '#dc2626'; // red - very fast
            if (avgTimeDiff <= 3) return '#ea580c'; // orange - fast
            if (avgTimeDiff <= 5) return '#d97706'; // yellow - medium
            return '#16a34a'; // green - slow
        }

        // Reset graph
        function resetGraph() {
            if (simulation) {
                simulation.alpha(1).restart();
            }
        }

        // Разблокировать все узлы (вернуть их в свободное движение)
        function unlockAllNodes() {
            if (simulation) {
                simulation.nodes().forEach(d => {
                    d.fx = null;
                    d.fy = null;
                });
                simulation.alpha(0.3).restart();
            }
        }

        // Фильтрация узлов по уровню подозрительности
        function filterNodes() {
            if (!svg || !simulation) return;

            const criticalChecked = document.getElementById('filter-critical').checked;
            const suspiciousChecked = document.getElementById('filter-suspicious').checked;
            const warningChecked = document.getElementById('filter-warning').checked;
            const normalChecked = document.getElementById('filter-normal').checked;
            const unknownChecked = document.getElementById('filter-unknown').checked;

            // Обновляем видимость узлов
            svg.selectAll('circle')
                .style('opacity', d => {
                    const level = d.suspicionLevel;
                    if (level === 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО' && criticalChecked) return 1;
                    if (level === 'ПОДОЗРИТЕЛЬНО' && suspiciousChecked) return 1;
                    if (level === 'ВНИМАНИЕ' && warningChecked) return 1;
                    if (level === 'НОРМА' && normalChecked) return 1;
                    if (level === 'Неизвестно' && unknownChecked) return 1;
                    return 0.1; // Скрываем, но оставляем видимыми для связей
                });

            // Обновляем видимость меток
            svg.selectAll('text')
                .style('opacity', d => {
                    const level = d.suspicionLevel;
                    if (level === 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО' && criticalChecked) return 1;
                    if (level === 'ПОДОЗРИТЕЛЬНО' && suspiciousChecked) return 1;
                    if (level === 'ВНИМАНИЕ' && warningChecked) return 1;
                    if (level === 'НОРМА' && normalChecked) return 1;
                    if (level === 'Неизвестно' && unknownChecked) return 1;
                    return 0.1;
                });

            // Обновляем видимость связей (показываем только если оба узла видимы)
            svg.selectAll('line')
                .style('opacity', d => {
                    const sourceVisible = isNodeVisible(d.source);
                    const targetVisible = isNodeVisible(d.target);
                    return (sourceVisible && targetVisible) ? 0.8 : 0.1;
                });

            // Подсчитываем видимые узлы
            updateVisibleNodesCount();
        }

        // Обновление счетчика видимых узлов
        function updateVisibleNodesCount() {
            if (!svg) return;
            
            const visibleCount = svg.selectAll('circle')
                .filter(d => d.suspicionLevel && isNodeVisible(d))
                .size();
            
            document.getElementById('visible-nodes-count').textContent = `Видимых узлов: ${visibleCount}`;
        }

        // Проверка видимости узла
        function isNodeVisible(node) {
            const level = node.suspicionLevel;
            const criticalChecked = document.getElementById('filter-critical').checked;
            const suspiciousChecked = document.getElementById('filter-suspicious').checked;
            const warningChecked = document.getElementById('filter-warning').checked;
            const normalChecked = document.getElementById('filter-normal').checked;
            const unknownChecked = document.getElementById('filter-unknown').checked;

            if (level === 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО' && criticalChecked) return true;
            if (level === 'ПОДОЗРИТЕЛЬНО' && suspiciousChecked) return true;
            if (level === 'ВНИМАНИЕ' && warningChecked) return true;
            if (level === 'НОРМА' && normalChecked) return true;
            if (level === 'Неизвестно' && unknownChecked) return true;
            return false;
        }

        // Выбрать все фильтры
        function selectAllFilters() {
            document.getElementById('filter-critical').checked = true;
            document.getElementById('filter-suspicious').checked = true;
            document.getElementById('filter-warning').checked = true;
            document.getElementById('filter-normal').checked = true;
            document.getElementById('filter-unknown').checked = true;
            filterNodes();
        }

        // Снять все фильтры
        function selectNoneFilters() {
            document.getElementById('filter-critical').checked = false;
            document.getElementById('filter-suspicious').checked = false;
            document.getElementById('filter-warning').checked = false;
            document.getElementById('filter-normal').checked = false;
            document.getElementById('filter-unknown').checked = false;
            filterNodes();
        }

        // Показать только критически подозрительных
        function showOnlyCritical() {
            document.getElementById('filter-critical').checked = true;
            document.getElementById('filter-suspicious').checked = false;
            document.getElementById('filter-warning').checked = false;
            document.getElementById('filter-normal').checked = false;
            document.getElementById('filter-unknown').checked = false;
            filterNodes();
        }

        // Показать только подозрительных
        function showOnlySuspicious() {
            document.getElementById('filter-critical').checked = false;
            document.getElementById('filter-suspicious').checked = true;
            document.getElementById('filter-warning').checked = false;
            document.getElementById('filter-normal').checked = false;
            document.getElementById('filter-unknown').checked = false;
            filterNodes();
        }

        // Фильтрация по количеству связей
        function filterByConnections() {
            if (!svg || !simulation) return;

            const minConnections = parseInt(document.getElementById('min-connections').value) || 1;
            
            // Подсчитываем количество связей для каждого узла
            const nodeConnections = new Map();
            svg.selectAll('line').each(function(d) {
                const source = d.source.id || d.source;
                const target = d.target.id || d.target;
                
                nodeConnections.set(source, (nodeConnections.get(source) || 0) + 1);
                nodeConnections.set(target, (nodeConnections.get(target) || 0) + 1);
            });

            // Обновляем видимость узлов на основе количества связей
            svg.selectAll('circle')
                .style('opacity', d => {
                    const connections = nodeConnections.get(d.id) || 0;
                    const isVisibleBySuspicion = isNodeVisible(d);
                    return (connections >= minConnections && isVisibleBySuspicion) ? 1 : 0.1;
                });

            // Обновляем видимость меток
            svg.selectAll('text')
                .style('opacity', d => {
                    const connections = nodeConnections.get(d.id) || 0;
                    const isVisibleBySuspicion = isNodeVisible(d);
                    return (connections >= minConnections && isVisibleBySuspicion) ? 1 : 0.1;
                });

            // Обновляем видимость связей
            svg.selectAll('line')
                .style('opacity', d => {
                    const sourceConnections = nodeConnections.get(d.source.id || d.source) || 0;
                    const targetConnections = nodeConnections.get(d.target.id || d.target) || 0;
                    const sourceVisible = sourceConnections >= minConnections && isNodeVisible(d.source);
                    const targetVisible = targetConnections >= minConnections && isNodeVisible(d.target);
                    return (sourceVisible && targetVisible) ? 0.8 : 0.1;
                });

            updateVisibleNodesCount();
        }

        // Показать самые связанные узлы
        function showMostConnected() {
            document.getElementById('min-connections').value = 5;
            filterByConnections();
        }

        // Сбросить фильтр по связям
        function resetConnectionFilter() {
            document.getElementById('min-connections').value = 1;
            filterNodes(); // Применяем только фильтр по подозрительности
        }

        // Export graph
        function exportGraph() {
            if (svg) {
                const svgData = new XMLSerializer().serializeToString(svg.node());
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    const link = document.createElement('a');
                    link.download = 'bot-network-graph.png';
                    link.href = canvas.toDataURL();
                    link.click();
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
            }
        }

        // Show lots for temporal pattern pair
        async function showTemporalPatternLots(group) {
            try {
                console.log('🔍 Загружаем лоты для пары пользователей:', group.users);
                
                // Создаем модальное окно
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 temporal-pattern-modal';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-6xl max-h-screen overflow-y-auto w-full mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Лоты пары пользователей: ${group.users.join(' ↔ ')}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="mb-4 text-sm text-gray-600">
                            <p><strong>Синхронных ставок:</strong> ${group.synchronous_count}</p>
                            <p><strong>Средний интервал:</strong> ${group.avg_time_diff} сек</p>
                            <p><strong>Уникальных лотов:</strong> ${group.unique_lots}</p>
                            <p><strong>Уровень риска:</strong> ${group.suspicion_level}</p>
                        </div>
                        <div id="temporal-pattern-lots-container" class="space-y-4">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                                <p class="mt-2 text-gray-600">Загружаем лоты...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Загружаем лоты для пары пользователей
                const response = await fetch(`/api/analytics/temporal-pattern-lots?user1=${group.users[0]}&user2=${group.users[1]}`);
                const result = await response.json();
                
                if (result.success) {
                    displayTemporalPatternLots(result.data, group);
                } else {
                    document.getElementById('temporal-pattern-lots-container').innerHTML = `
                        <div class="text-center text-red-600">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Ошибка загрузки лотов: ${result.error}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Ошибка загрузки лотов для пары пользователей:', error);
                alert('Ошибка загрузки лотов');
            }
        }

        // Display lots for temporal pattern pair
        function displayTemporalPatternLots(lots, group) {
            const container = document.getElementById('temporal-pattern-lots-container');
            
            if (lots.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-600">
                        <i class="fas fa-info-circle text-2xl mb-2"></i>
                        <p>Лоты не найдены</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = lots.map(lot => `
                <div class="border rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer" onclick="showLotModalAndCloseList('${lot.lot_id}')">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-lg">Лот ${lot.lot_id}</h4>
                            <p class="text-sm text-gray-600">Аукцион ${lot.auction_number}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-600">${formatPrice(lot.winning_bid)}</p>
                            <p class="text-sm text-gray-500">Победитель: ${lot.winner_login}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p><strong>Пользователь 1:</strong> ${lot.user1} (${lot.timestamp1})</p>
                            <p><strong>Пользователь 2:</strong> ${lot.user2} (${lot.timestamp2})</p>
                        </div>
                        <div>
                            <p><strong>Интервал:</strong> ${lot.time_diff_seconds} сек</p>
                            <p><strong>Категория:</strong> ${lot.category || 'Не указана'}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show lot modal and close temporal pattern list
        function showLotModalAndCloseList(lotId) {
            // Закрываем модальное окно со списком лотов (используем уникальный класс)
            const temporalModal = document.querySelector('.temporal-pattern-modal');
            if (temporalModal) {
                temporalModal.remove();
            }
            
            // Небольшая задержка для корректного закрытия предыдущего модального окна
            setTimeout(() => {
                showLotModal(lotId);
            }, 100);
        }

        // Drag functions for D3.js graph
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            // НЕ сбрасываем fx и fy - оставляем узел в новом положении
            // d.fx = null;
            // d.fy = null;
        }

        // Load suspicious users
        async function loadSuspiciousUsers(event) {
            const button = event.target;
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Загрузка...';
                button.disabled = true;

                const threshold = prompt('Введите минимальный порог скоринга подозрительности (по умолчанию 30):', '30') || '30';
                const response = await fetch(`/api/analytics/suspicious-users?threshold=${threshold}`);
                const result = await response.json();
                
                if (result.success) {
                    displaySuspiciousUsers(result.data);
                    document.getElementById('autobid-traps-count').textContent = `Найдено ${result.data.length} подозрительных пользователей (порог: ${threshold})`;
                    document.getElementById('autobid-traps-results').classList.remove('hidden');
                } else {
                    alert('Ошибка загрузки данных: ' + result.error);
                }
            } catch (error) {
                console.error('Ошибка загрузки подозрительных пользователей:', error);
                alert('Ошибка загрузки данных');
            } finally {
                button.innerHTML = '<i class="fas fa-users mr-2"></i>Подозрительные пользователи';
                button.disabled = false;
            }
        }

        // Display suspicious users results
        function displaySuspiciousUsers(data) {
            const tbody = document.getElementById('autobid-traps-table-body');
            tbody.innerHTML = '';

            // Update table headers for suspicious users
            const thead = document.querySelector('#autobid-traps-results thead tr');
            thead.innerHTML = `
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Пользователь</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Общий скоринг</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Быстрые ставки</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ловушки автобида</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Манипуляции</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Рейтинг</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Потрачено</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Лотов</th>
            `;

            data.forEach(user => {
                const row = document.createElement('tr');
                
                // Suspicious score styling
                let scoreClass = 'text-gray-600';
                let scoreIcon = '';
                if (user.suspicious_score >= 80) {
                    scoreClass = 'text-red-600 font-bold';
                    scoreIcon = '<i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>';
                } else if (user.suspicious_score >= 50) {
                    scoreClass = 'text-orange-600 font-semibold';
                    scoreIcon = '<i class="fas fa-exclamation-circle text-orange-500 mr-1"></i>';
                } else if (user.suspicious_score >= 30) {
                    scoreClass = 'text-yellow-600 font-medium';
                    scoreIcon = '<i class="fas fa-info-circle text-yellow-500 mr-1"></i>';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${user.winner_login}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${scoreClass}">
                        ${scoreIcon}${user.suspicious_score}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold ${user.fast_bids_score > 0 ? 'text-orange-600' : 'text-gray-400'}">${user.fast_bids_score || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold ${user.autobid_traps_score > 0 ? 'text-red-600' : 'text-gray-400'}">${user.autobid_traps_score || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold ${user.manipulation_score > 0 ? 'text-purple-600' : 'text-gray-400'}">${user.manipulation_score || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${user.rating || 'N/A'}</span>
                        <div class="text-xs text-gray-500">${user.category || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${parseFloat(user.total_spent || 0).toLocaleString()} ₽</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="font-semibold">${user.total_lots || 0}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Элементы модального окна (как в app.js)
        const elements = {
            lotModal: document.getElementById('lotModal'),
            modalTitle: document.getElementById('modalTitle'),
            modalContent: document.getElementById('modalContent'),
            closeModal: document.getElementById('closeModal')
        };
        
        // Функция показа модального окна лота (ТОЧНАЯ копия из app.js)
        async function showLotModal(lotId) {
            try {
                const response = await fetch(`/api/lot-details/${lotId}`);
                const lot = await response.json();
                
                elements.modalTitle.innerHTML = `
                    <i class="fas fa-coins text-yellow-500 mr-2"></i>
                    Лот ${lot.lot_number} (Аукцион ${lot.auction_number})
                `;
                
                const imageUrl = lot.avers_image_url || '/placeholder-coin.png';
                const reversImageUrl = lot.revers_image_url || '/placeholder-coin.png';
                
                elements.modalContent.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-lg font-semibold mb-4">
                                <i class="fas fa-images text-blue-500 mr-2"></i>Изображения
                            </h4>
                            <div class="space-y-4">
                                ${lot.avers_image_url ? `
                                    <div>
                                        <p class="text-sm text-gray-600 mb-2">Аверс</p>
                                        <img src="${imageUrl}" alt="Аверс" class="w-full h-64 object-cover rounded-lg border shadow-sm"
                                             onerror="this.src='/placeholder-coin.png'">
                                    </div>
                                ` : ''}
                                ${lot.revers_image_url ? `
                                    <div>
                                        <p class="text-sm text-gray-600 mb-2">Реверс</p>
                                        <img src="${reversImageUrl}" alt="Реверс" class="w-full h-64 object-cover rounded-lg border shadow-sm"
                                             onerror="this.src='/placeholder-coin.png'">
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-lg font-semibold mb-4">
                                <i class="fas fa-info-circle text-green-500 mr-2"></i>Информация о лоте
                            </h4>
                            <div class="space-y-4">
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h5 class="font-medium text-gray-800 mb-2">Описание</h5>
                                    <p class="text-sm text-gray-700 leading-relaxed">${lot.coin_description || 'Описание не указано'}</p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-blue-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">Год</p>
                                        <p class="font-medium text-blue-800">${lot.year || 'Не указан'}</p>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">Металл</p>
                                        <p class="font-medium text-green-800">${lot.metal || 'Не указан'}</p>
                                    </div>
                                    <div class="bg-yellow-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">Сохранность</p>
                                        <p class="font-medium text-yellow-800">${lot.condition || 'Не указана'}</p>
                                    </div>
                                    <div class="bg-purple-50 rounded-lg p-3">
                                        <p class="text-sm text-gray-600">Буквы</p>
                                        <p class="font-medium text-purple-800">${lot.letters || 'Не указаны'}</p>
                                    </div>
                                    ${lot.weight ? `
                                        <div class="bg-orange-50 rounded-lg p-3">
                                            <p class="text-sm text-gray-600">Вес</p>
                                            <p class="font-medium text-orange-800">${lot.weight}г</p>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Прогнозная цена -->
                                <div id="modal-prediction-${lot.id}" class="mb-4">
                                    <!-- Прогнозная цена будет загружена асинхронно -->
                                </div>
                                
                                <div class="bg-green-50 rounded-lg p-4">
                                    <h5 class="font-medium text-gray-800 mb-3">
                                        <i class="fas fa-gavel text-green-600 mr-2"></i>Результаты торгов
                                    </h5>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Победитель:</span>
                                            <div id="modal-winner-${lot.id}" class="font-medium text-green-800"></div>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Цена:</span>
                                            <span class="font-bold text-green-600 text-lg">${lot.winning_bid ? formatPrice(lot.winning_bid) : 'Не продано'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Количество ставок:</span>
                                            <span class="font-medium text-gray-800 cursor-pointer hover:text-blue-600 transition-colors" onclick="showBidsModal(${lot.id})">${lot.bids_count || 0}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Статус:</span>
                                            <span class="font-medium text-gray-800">${lot.lot_status || 'Не указан'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Дата окончания:</span>
                                            <span class="font-medium text-gray-800">${lot.auction_end_date ? new Date(lot.auction_end_date).toLocaleDateString('ru-RU') : 'Не указана'}</span>
                                        </div>
                                    </div>
                                    <div id="modal-metal-info-${lot.id}" class="mt-4">
                                        <!-- Информация о металле будет загружена асинхронно -->
                                    </div>
                                </div>
                                
                                <!-- Кнопки действий -->
                                <div class="flex items-center justify-center pt-4 border-t">
                                    <div class="flex space-x-2">
                                        <button onclick="loadPriceHistory(${lot.id})" 
                                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition-colors text-sm"
                                                title="Анализ цены">
                                            <i class="fas fa-chart-line"></i>
                                        </button>
                                        <button onclick="addToWatchlist(${lot.id})" 
                                                class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-2 rounded-lg transition-colors text-sm"
                                                title="Добавить в избранное">
                                            <i class="fas fa-star"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Price History Section (initially hidden) -->
                                <div id="priceHistory-${lot.id}" class="hidden mt-4 pt-4 border-t">
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h5 class="font-semibold text-gray-800 mb-3">
                                            <i class="fas fa-history mr-2"></i>История цен аналогичных лотов
                                        </h5>
                                        <div id="priceHistoryContent-${lot.id}" class="text-center py-4">
                                            <i class="fas fa-spinner fa-spin text-blue-500 mr-2"></i>
                                            Загрузка истории цен...
                                        </div>
                                    </div>
                                </div>
                                
                                ${lot.source_url ? `
                                    <div class="border-t pt-4">
                                        <a href="${lot.source_url}" target="_blank" 
                                           class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors">
                                            <i class="fas fa-external-link-alt mr-2"></i>
                                            Открыть на сайте аукциона
                                        </a>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Add clickable winner link in modal
                const modalWinnerContainer = document.querySelector(`#modal-winner-${lot.id}`);
                if (modalWinnerContainer && lot.winner_login) {
                    const winnerLink = createWinnerLink(lot.winner_login);
                    modalWinnerContainer.appendChild(winnerLink);
                } else if (modalWinnerContainer) {
                    modalWinnerContainer.textContent = 'Не указан';
                }
                
                // Загружаем информацию о металле асинхронно
                if (lot.winning_bid && lot.metal && lot.weight) {
                    loadMetalInfo(lot.id).then(metalInfo => {
                        const modalMetalInfoContainer = document.querySelector(`#modal-metal-info-${lot.id}`);
                        if (modalMetalInfoContainer && metalInfo) {
                            modalMetalInfoContainer.innerHTML = createMetalInfoHTML(metalInfo);
                        }
                    });
                }
                
                // Загружаем прогнозную цену асинхронно
                loadLotPrediction(lot.id);
                
                elements.lotModal.classList.remove('hidden');
                
            } catch (error) {
                console.error('Ошибка загрузки лота:', error);
                elements.modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                        <p class="text-red-600">Ошибка загрузки данных лота</p>
                    </div>
                `;
                elements.lotModal.classList.remove('hidden');
            }
        }
        
        // Закрытие модального окна
        elements.closeModal.addEventListener('click', () => {
            elements.lotModal.classList.add('hidden');
        });
        
        // Закрытие по клику вне модального окна
        elements.lotModal.addEventListener('click', (e) => {
            if (e.target === elements.lotModal) {
                elements.lotModal.classList.add('hidden');
            }
        });
        
        // Вспомогательные функции (скопированы из app.js)
        function formatPrice(price) {
            if (!price) return 'Не указана';
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }
        
        function createWinnerLink(winnerLogin) {
            if (!winnerLogin) return 'Не указан';
            
            const container = document.createElement('div');
            container.className = 'flex items-center space-x-2';
            
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'text-blue-600 hover:text-blue-800 hover:underline font-medium';
            link.textContent = winnerLogin;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // Prevent event bubbling to parent elements
                // Здесь можно добавить функционал поиска по победителю
                console.log('Поиск по победителю:', winnerLogin);
            });
            
            container.appendChild(link);
            
            // Загружаем рейтинг асинхронно
            getCachedRating(winnerLogin).then(rating => {
                if (rating) {
                    // Рейтинг
                    const ratingBadge = document.createElement('span');
                    ratingBadge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium';
                    ratingBadge.style.backgroundColor = rating.color;
                    ratingBadge.style.color = 'white';
                    ratingBadge.innerHTML = `${rating.icon} ${rating.rating}`;
                    container.appendChild(ratingBadge);
                    
                    // Скоринг подозрительности (если есть)
                    if (rating.suspiciousLevel) {
                        const suspiciousBadge = document.createElement('span');
                        suspiciousBadge.className = 'inline-flex items-center px-2 py-1 rounded-full text-xs font-medium';
                        suspiciousBadge.style.backgroundColor = rating.suspiciousLevel.color;
                        suspiciousBadge.style.color = 'white';
                        suspiciousBadge.innerHTML = `${rating.suspiciousLevel.icon} ${rating.suspiciousScore}`;
                        suspiciousBadge.title = `Подозрительность: ${rating.suspiciousLevel.level}`;
                        container.appendChild(suspiciousBadge);
                    }
                }
            });
            
            return container;
        }
        
        async function loadMetalInfo(lotId) {
            try {
                const response = await fetch(`/api/numismatic-premium/${lotId}`);
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('Ошибка загрузки информации о металле:', error);
                return null;
            }
        }
        
        function createMetalInfoHTML(metalInfo) {
            if (!metalInfo) return '';
            
            const { metal_price, numismatic_premium } = metalInfo;
            const metalValue = parseFloat(numismatic_premium.metalValue).toLocaleString('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            });
            const premium = parseFloat(numismatic_premium.premium).toLocaleString('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                minimumFractionDigits: 0
            });
            const premiumPercent = parseFloat(numismatic_premium.premiumPercent).toFixed(1);
            
            return `
                <div class="bg-blue-50 rounded-lg p-3">
                    <h6 class="font-medium text-blue-800 mb-2">Анализ металла</h6>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-blue-700">Стоимость металла:</span>
                            <span class="font-medium text-blue-800">${metalValue}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700">Нумизматическая премия:</span>
                            <span class="font-medium text-blue-800">${premium} (${premiumPercent}%)</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Функции для модального окна ставок (скопированы из app.js)
        async function showBidsModal(lotId) {
            const modal = document.getElementById('bidsModal');
            const loading = document.getElementById('bidsLoading');
            const content = document.getElementById('bidsContent');
            const empty = document.getElementById('bidsEmpty');
            
            // Показываем модальное окно
            modal.classList.remove('hidden');
            
            // Показываем загрузку
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            empty.classList.add('hidden');
            
            try {
                // Загружаем историю ставок
                const response = await fetch(`/api/lots/${lotId}/bids`);
                const data = await response.json();
                
                if (data.success && data.bids.length > 0) {
                    // Показываем ставки
                    displayBids(data.bids);
                    loading.classList.add('hidden');
                    content.classList.remove('hidden');
                } else {
                    // Показываем пустое состояние
                    loading.classList.add('hidden');
                    empty.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Ошибка загрузки истории ставок:', error);
                loading.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }
        
        function closeBidsModal() {
            document.getElementById('bidsModal').classList.add('hidden');
        }
        
        // Отобразить ставки в таблице
        async function displayBids(bids) {
            const countElement = document.getElementById('bidsCount');
            const tableBody = document.getElementById('bidsTableBody');
            
            // Обновляем счетчик
            countElement.textContent = bids.length;
            
            // Очищаем таблицу
            tableBody.innerHTML = '';
            
            // Добавляем ставки
            for (let index = 0; index < bids.length; index++) {
                const bid = bids[index];
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const bidTime = new Date(bid.bid_timestamp).toLocaleString('ru-RU');
                const bidAmount = formatPrice(bid.bid_amount);
                const bidType = bid.is_auto_bid ? 
                    '<span class="px-2 py-1 text-xs font-medium bg-purple-100 text-purple-800 rounded-full">Автобид</span>' :
                    '<span class="px-2 py-1 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Ручная</span>';
                
                // Создаем ячейки
                const timeCell = document.createElement('td');
                timeCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-600';
                timeCell.textContent = bidTime;
                
                const userCell = document.createElement('td');
                userCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900';
                
                const amountCell = document.createElement('td');
                amountCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600';
                amountCell.textContent = bidAmount;
                
                const typeCell = document.createElement('td');
                typeCell.className = 'px-6 py-4 whitespace-nowrap text-sm';
                typeCell.innerHTML = bidType;
                
                // Загружаем рейтинг пользователя и добавляем в ячейку
                const rating = await getCachedRating(bid.bidder_login);
                if (rating) {
                    const ratingElement = createWinnerLink(bid.bidder_login, rating);
                    userCell.appendChild(ratingElement);
                } else {
                    userCell.textContent = bid.bidder_login;
                }
                
                // Добавляем ячейки в строку
                row.appendChild(timeCell);
                row.appendChild(userCell);
                row.appendChild(amountCell);
                row.appendChild(typeCell);
                
                tableBody.appendChild(row);
            }
        }
        
        // Кэш рейтингов для быстрого доступа
        const ratingsCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 минут

        // Функция для загрузки рейтинга победителя
        async function loadWinnerRating(winnerLogin) {
            try {
                const response = await fetch(`/api/ratings/${winnerLogin}`);
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('Ошибка загрузки рейтинга победителя:', error);
                return null;
            }
        }

        // Функция для получения кэшированного рейтинга
        async function getCachedRating(winnerLogin) {
            const cached = ratingsCache.get(winnerLogin);
            if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }
            
            const rating = await loadWinnerRating(winnerLogin);
            if (rating) {
                ratingsCache.set(winnerLogin, {
                    data: rating,
                    timestamp: Date.now()
                });
            }
            
            return rating;
        }

        // Функции для работы с прогнозами (скопированы из app.js)
        async function loadLotPrediction(lotId) {
            try {
                const response = await fetch(`/api/prediction/${lotId}`);
                if (!response.ok) {
                    throw new Error('Прогноз не найден');
                }
                
                const prediction = await response.json();
                displayLotPrediction(lotId, prediction);
            } catch (error) {
                console.error('Ошибка загрузки прогноза:', error);
                // Скрываем секцию прогноза если нет данных
                const predictionElement = document.querySelector(`#modal-prediction-${lotId}`);
                if (predictionElement) {
                    predictionElement.style.display = 'none';
                }
            }
        }
        
        function displayLotPrediction(lotId, prediction) {
            const predictionElement = document.querySelector(`#modal-prediction-${lotId}`);
            if (!predictionElement) {
                return;
            }
            
            // Если прогнозная цена null (нет аналогичных лотов), показываем соответствующее сообщение
            if (prediction.predicted_price === null) {
                predictionElement.innerHTML = `
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <i class="fas fa-question-circle text-gray-500 mr-2"></i>
                                <h5 class="font-semibold text-gray-700">Прогнозная цена</h5>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                                Недостаточно данных
                            </span>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">Аналогичные лоты не найдены</p>
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-info-circle mr-1"></i>
                                Для точного прогноза нужны исторические данные аналогичных монет
                            </p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Если прогнозная цена равна 0 или undefined, скрываем блок
            if (!prediction.predicted_price || prediction.predicted_price <= 0) {
                predictionElement.style.display = 'none';
                return;
            }
            
            const predictedPrice = prediction.predicted_price;
            const confidence = Math.round((prediction.confidence_score || 0) * 100);
            const currentBid = prediction.current_bid_amount || prediction.winning_bid || 0;
            
            // Рассчитываем разность между прогнозом и актуальной текущей ставкой
            const difference = predictedPrice - currentBid;
            const differencePercent = currentBid > 0 ? Math.round((difference / currentBid) * 100) : 0;
            
            // Определяем цветовую схему на основе разности
            let bgColor, textColor, iconColor, borderColor;
            if (difference > 0) {
                // Прогноз выше текущей ставки - хорошая возможность
                bgColor = 'bg-green-50';
                textColor = 'text-green-800';
                iconColor = 'text-green-600';
                borderColor = 'border-green-200';
            } else if (difference < 0) {
                // Прогноз ниже текущей ставки - переплата
                bgColor = 'bg-red-50';
                textColor = 'text-red-800';
                iconColor = 'text-red-600';
                borderColor = 'border-red-200';
            } else {
                // Прогноз равен текущей ставке
                bgColor = 'bg-blue-50';
                textColor = 'text-blue-800';
                iconColor = 'text-blue-600';
                borderColor = 'border-blue-200';
            }
            
            // Определяем уровень уверенности
            let confidenceLevel, confidenceText;
            if (confidence >= 80) {
                confidenceLevel = 'bg-green-100 text-green-800';
                confidenceText = 'Высокая';
            } else if (confidence >= 60) {
                confidenceLevel = 'bg-yellow-100 text-yellow-800';
                confidenceText = 'Средняя';
            } else {
                confidenceLevel = 'bg-red-100 text-red-800';
                confidenceText = 'Низкая';
            }
            
            predictionElement.innerHTML = `
                <div class="bg-gradient-to-r ${bgColor} border ${borderColor} rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <i class="fas fa-crystal-ball ${iconColor} mr-2"></i>
                            <h5 class="font-semibold ${textColor}">Прогнозная цена</h5>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${confidenceLevel}">
                                ${confidenceText} (${confidence}%)
                            </span>
                            <span class="text-xs ${textColor}">
                                ${getPredictionMethodText(prediction.prediction_method)}${prediction.sample_size ? ` (${prediction.sample_size})` : ''}
                            </span>
                        </div>
                    </div>
                    
                    ${prediction.prediction_created_at ? `
                        <div class="mb-3 text-center">
                            <p class="text-xs ${textColor} opacity-75">
                                <i class="fas fa-clock mr-1"></i>
                                Последний перерасчет: ${formatPredictionDate(prediction.prediction_created_at)}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <p class="text-sm ${textColor} mb-1">Прогнозная цена</p>
                            <p class="text-xl font-bold ${textColor}">${formatPrice(predictedPrice)}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm ${textColor} mb-1">Разность</p>
                            <div class="flex items-center justify-center">
                                <i class="fas ${difference > 0 ? 'fa-arrow-up' : difference < 0 ? 'fa-arrow-down' : 'fa-minus'} ${iconColor} mr-1"></i>
                                <span class="text-lg font-bold ${textColor}">
                                    ${difference > 0 ? '+' : ''}${formatPrice(Math.abs(difference))}
                                </span>
                            </div>
                            <p class="text-xs ${textColor}">
                                ${differencePercent > 0 ? '+' : ''}${differencePercent}%
                            </p>
                        </div>
                    </div>
                    
                    ${prediction.metal_value > 0 ? `
                        <div class="mt-3 pt-3 border-t ${borderColor}">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="text-center">
                                    <p class="${textColor} mb-1">Стоимость металла</p>
                                    <p class="font-semibold ${textColor}">${formatPrice(prediction.metal_value)}</p>
                                </div>
                                <div class="text-center">
                                    <p class="${textColor} mb-1">Нумизматическая наценка</p>
                                    <p class="font-semibold ${textColor}">${formatPrice(prediction.numismatic_premium)}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mt-3 pt-3 border-t ${borderColor}">
                        <p class="text-xs ${textColor} text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            Прогноз основан на исторических данных аналогичных лотов
                        </p>
                    </div>
                </div>
            `;
        }
        
        function getPredictionMethodText(method) {
            const methodTexts = {
                'no_similar_lots': 'Нет аналогов',
                'single_similar_lot': '1 аналог',
                'statistical_model': 'Стат. модель',
                'calibrated': 'Калиброванная',
                'simple': 'Упрощенная',
                'simplified_model': 'Упрощенная'
            };
            return methodTexts[method] || method || 'Неизвестно';
        }
        
        function formatPredictionDate(dateString) {
            if (!dateString) return 'Не указана';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            
            if (diffMinutes < 60) {
                return `${diffMinutes} мин назад`;
            } else if (diffHours < 24) {
                return `${diffHours} ч назад`;
            } else if (diffDays < 7) {
                return `${diffDays} дн назад`;
            } else {
                return date.toLocaleDateString('ru-RU');
            }
        }
        
        // Функции для истории цен (скопированы из app.js)
        async function loadPriceHistory(lotId) {
            const priceHistorySection = document.querySelector(`#priceHistory-${lotId}`);
            const priceHistoryContent = document.querySelector(`#priceHistoryContent-${lotId}`);
            
            // Toggle visibility
            if (priceHistorySection.classList.contains('hidden')) {
                priceHistorySection.classList.remove('hidden');
                
                // Load price history if not already loaded
                if (priceHistoryContent.innerHTML.includes('Загрузка истории цен')) {
                    try {
                        const response = await fetch(`/api/similar-lots/${lotId}`);
                        const data = await response.json();
                        
                        displayPriceHistory(lotId, data);
                    } catch (error) {
                        console.error('Ошибка загрузки истории цен:', error);
                        priceHistoryContent.innerHTML = `
                            <div class="text-red-600">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Ошибка загрузки истории цен
                            </div>
                        `;
                    }
                }
            } else {
                priceHistorySection.classList.add('hidden');
            }
        }
        
        function displayPriceHistory(lotId, data) {
            const priceHistoryContent = document.querySelector(`#priceHistoryContent-${lotId}`);
            const { currentLot, similarLots } = data;
            
            if (similarLots.length === 0) {
                priceHistoryContent.innerHTML = `
                    <div class="text-gray-600">
                        <i class="fas fa-info-circle mr-2"></i>
                        Аналогичные лоты не найдены
                    </div>
                `;
                return;
            }
            
            // Calculate price statistics
            const prices = similarLots.map(lot => lot.winning_bid);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            
            let historyHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <p class="text-sm text-gray-600">Минимальная цена</p>
                        <p class="text-lg font-bold text-green-600">${formatPrice(minPrice)}</p>
                    </div>
                    <div class="bg-red-50 rounded-lg p-3 text-center">
                        <p class="text-sm text-gray-600">Максимальная цена</p>
                        <p class="text-lg font-bold text-red-600">${formatPrice(maxPrice)}</p>
                    </div>
                </div>
                
                <div class="space-y-2">
                    <h6 class="font-medium text-gray-800 mb-2">Аналогичные лоты:</h6>
            `;
            
            similarLots.slice(0, 5).forEach(lot => {
                historyHTML += `
                    <div class="py-2 px-3 bg-white rounded border cursor-pointer hover:bg-gray-50 transition-colors" 
                         onclick="showLotModal(${lot.id})">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-sm font-medium">Лот ${lot.lot_number} (Аукцион ${lot.auction_number})</p>
                                <p class="text-xs text-gray-500">${lot.year}г. • ${lot.metal} • ${lot.condition}${lot.weight ? ` • ${lot.weight}г` : ''}</p>
                                <p class="text-xs text-gray-500">${formatPredictionDate(lot.auction_end_date)}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-600">${formatPrice(lot.winning_bid)}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            historyHTML += '</div>';
            priceHistoryContent.innerHTML = historyHTML;
        }
        
        // Заглушка для addToWatchlist (можно реализовать позже)
        function addToWatchlist(lotId) {
            console.log('Добавление в избранное:', lotId);
            // Здесь можно добавить функционал добавления в избранное
        }

        // Функции для новых вкладок аналитики

        // Круговые покупки
        async function loadCircularBuyers() {
            const minPurchases = document.getElementById('circularMinPurchases').value;
            const months = document.getElementById('circularMonths').value;
            
            try {
                const response = await fetch(`/api/analytics/circular-buyers?min_purchases=${minPurchases}&months=${months}`);
                const data = await response.json();
                
                if (data.success) {
                    displayCircularBuyers(data.data);
                    document.getElementById('circular-buyers-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка загрузки круговых покупок:', error);
                alert('Ошибка загрузки данных');
            }
        }

        function displayCircularBuyers(data) {
            const tbody = document.getElementById('circular-buyers-table');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.winner_login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.coin_description} ${item.year} (${item.condition})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.purchase_count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.avg_price.toFixed(0)}₽</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.avg_competition.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.suspicion_score}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(item.risk_level)}">
                            ${item.risk_level}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Связанные аккаунты
        async function loadLinkedAccounts() {
            const similarityThreshold = document.getElementById('linkedSimilarityThreshold').value;
            const minBids = document.getElementById('linkedMinBids').value;
            
            try {
                const response = await fetch(`/api/analytics/linked-accounts?similarity_threshold=${similarityThreshold}&min_bids=${minBids}`);
                const data = await response.json();
                
                if (data.success) {
                    displayLinkedAccounts(data.data);
                    // Сохраняем последнюю выборку пар для кнопки "Построить граф"
                    window._lastLinkedAccountsPairs = data.data;
                    // Строим граф сразу после загрузки
                    renderLinkedAccountsGraph(data.data);
                    document.getElementById('linked-accounts-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка загрузки связанных аккаунтов:', error);
                alert('Ошибка загрузки данных');
            }
        }

        function displayLinkedAccounts(data) {
            const tbody = document.getElementById('linked-accounts-table');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.user1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.user2}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.similarity * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.hourly_similarity * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.autobid_similarity * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(item.risk_level)}">
                            ${item.risk_level}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Построение графа для связанных аккаунтов
        function renderLinkedAccountsGraph(pairs) {
            const container = document.getElementById('linked-graph-container');
            if (!container) return;
            container.innerHTML = '';

            // Собираем узлы и связи
            const userSet = new Set();
            const links = [];
            pairs.forEach(p => {
                userSet.add(p.user1);
                userSet.add(p.user2);
                links.push({
                    source: p.user1,
                    target: p.user2,
                    similarity: p.similarity,
                    hourly_similarity: p.hourly_similarity,
                    autobid_similarity: p.autobid_similarity
                });
            });

            // Считаем количество связей (степень узла)
            const degreeMap = new Map();
            links.forEach(l => {
                degreeMap.set(l.source, (degreeMap.get(l.source) || 0) + 1);
                degreeMap.set(l.target, (degreeMap.get(l.target) || 0) + 1);
            });

            const nodes = Array.from(userSet).map(u => ({
                id: u,
                name: u,
                degree: degreeMap.get(u) || 0
            }));

            // Параметры размеров
            const width = container.clientWidth;
            const height = container.clientHeight;

            const maxDegree = nodes.length ? Math.max(...nodes.map(n => n.degree)) : 1;
            const radiusScale = d3.scaleSqrt().domain([1, Math.max(1, maxDegree)]).range([6, 24]);

            const svg = d3.select('#linked-graph-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .call(d3.zoom().on('zoom', (event) => {
                    g.attr('transform', event.transform);
                }));

            const g = svg.append('g');

            const linkColor = (s) => s >= 0.98 ? '#dc2626' : s >= 0.95 ? '#fb923c' : s >= 0.92 ? '#f59e0b' : '#94a3b8';
            const linkWidth = (s) => 1 + (s - 0.9) * 10; // толщина пропорциональна похожести

            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(d => 120 - Math.max(0, (d.similarity - 0.9)) * 200))
                .force('charge', d3.forceManyBody().strength(-200))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => radiusScale(Math.max(1, d.degree)) + 4))
                .alphaDecay(0.05)
                .velocityDecay(0.3);

            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('stroke', d => linkColor(d.similarity))
                .attr('stroke-width', d => linkWidth(d.similarity))
                .attr('stroke-opacity', 0.8);

            const node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter().append('circle')
                .attr('r', d => radiusScale(Math.max(1, d.degree)))
                .attr('fill', '#3b82f6')
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x; d.fy = d.y;
                    })
                    .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
                    .on('end', (event, d) => { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }));

            const label = g.append('g')
                .selectAll('text')
                .data(nodes)
                .enter().append('text')
                .text(d => d.name)
                .attr('font-size', '11px')
                .attr('font-weight', '600')
                .attr('text-anchor', 'middle')
                .attr('dy', '-1.1em')
                .attr('fill', '#334155');

            // Tooltips
            node.append('title')
                .text(d => `${d.name}\nСвязей: ${d.degree}`);
            link.append('title')
                .text(d => `${d.source.id} ↔ ${d.target.id}\nПохожесть: ${(d.similarity*100).toFixed(1)}%\nВременная: ${(d.hourly_similarity*100).toFixed(1)}%\nАвтобиды: ${(d.autobid_similarity*100).toFixed(1)}%`);

            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }

        function resetLinkedGraph() {
            if (window._lastLinkedAccountsPairs) {
                renderLinkedAccountsGraph(window._lastLinkedAccountsPairs);
            }
        }

        // Карусель перепродаж
        async function loadCarouselAnalysis() {
            const minSales = document.getElementById('carouselMinSales').value;
            const maxWeeks = document.getElementById('carouselMaxWeeks').value;
            const months = document.getElementById('carouselMonths').value;
            const limit = document.getElementById('carouselLimit').value;
            
            try {
                const response = await fetch(`/api/analytics/carousel-analysis?min_sales=${minSales}&max_weeks=${maxWeeks}&months=${months}&limit=${limit}`);
                const data = await response.json();
                
                if (data.success) {
                    displayCarouselAnalysis(data.data);
                    document.getElementById('carousel-analysis-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка загрузки карусели:', error);
                alert('Ошибка загрузки данных');
            }
        }

        function displayCarouselAnalysis(data) {
            const tbody = document.getElementById('carousel-analysis-table');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => loadCarouselDetails(item.coin_description, item.year, item.condition);
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.coin_description} ${item.year} (${item.condition})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.sales_count}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.unique_winners ?? '') || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.time_span_weeks}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.price_growth_pct.toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.carousel_score}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(item.risk_level)}">
                            ${item.risk_level}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ====== Детали карусели: модал, загрузка и отрисовка ======
        async function loadCarouselDetails(coinDescription, year, condition) {
            try {
                const months = document.getElementById('carouselMonths') ? document.getElementById('carouselMonths').value : 6;
                const params = new URLSearchParams({ coin_description: coinDescription, year, condition, months });
                const response = await fetch(`/api/analytics/carousel-details?${params.toString()}`);
                const data = await response.json();
                if (!data.success) {
                    alert('Ошибка загрузки деталей карусели');
                    return;
                }
                openCarouselModal(coinDescription, year, condition);
                renderCarouselTimeline(data.data.sales);
                renderCarouselGraph(data.data.graph);
                renderCarouselDetailsTable(data.data.sales, data.data.participantsByLot);
            } catch (e) {
                console.error('Ошибка деталей карусели:', e);
                alert('Ошибка загрузки деталей');
            }
        }

        function openCarouselModal(coinDescription, year, condition) {
            const modal = document.getElementById('carousel-details-modal');
            document.getElementById('carousel-details-title').textContent = `${coinDescription} ${year} (${condition})`;
            modal.classList.remove('hidden');
        }

        // ====== Technical bidders ======
        async function loadTechnicalBidders() {
            const minBids = document.getElementById('technicalMinBids').value;
            const months = document.getElementById('technicalMonths').value;
            try {
                const resp = await fetch(`/api/analytics/technical-bidders?min_bids=${minBids}&months=${months}`);
                const data = await resp.json();
                if (data.success) {
                    displayTechnicalBidders(data.data);
                    document.getElementById('technical-bidders-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.error);
                }
            } catch (e) {
                console.error('Ошибка загрузки технических пользователей:', e);
                alert('Ошибка загрузки данных');
            }
        }

        function displayTechnicalBidders(items) {
            const tbody = document.getElementById('technical-bidders-table');
            tbody.innerHTML = '';
            items.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-700">${u.bidder_login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${u.manual_bids}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${u.auto_bids}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${u.total_bids}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${u.distinct_lots}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(u.fast_manual_share*100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${u.wins}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(u.risk_level)}">${u.risk_level}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function closeCarouselModal() {
            const modal = document.getElementById('carousel-details-modal');
            modal.classList.add('hidden');
        }

        function renderCarouselTimeline(sales) {
            const container = document.getElementById('carousel-timeline');
            container.innerHTML = '';
            const width = container.clientWidth || 800;
            const height = 140;
            const margin = { left: 40, right: 20, top: 20, bottom: 30 };
            const svg = d3.select('#carousel-timeline').append('svg').attr('width', width).attr('height', height);

            if (!sales || sales.length === 0) return;
            const parseDate = d => new Date(d);
            const dates = sales.map(s => parseDate(s.auction_end_date));
            const x = d3.scaleTime().domain([d3.min(dates), d3.max(dates)]).range([margin.left, width - margin.right]);

            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5));

            const y = height / 2;
            svg.append('line').attr('x1', margin.left).attr('x2', width - margin.right).attr('y1', y).attr('y2', y).attr('stroke', '#e5e7eb');

            svg.selectAll('circle')
                .data(sales)
                .enter().append('circle')
                .attr('cx', s => x(parseDate(s.auction_end_date)))
                .attr('cy', y)
                .attr('r', 6)
                .attr('fill', '#2563eb')
                .append('title')
                .text(s => `${new Date(s.auction_end_date).toLocaleDateString()}\nПобедитель: ${s.winner_login}\nЦена: ${s.winning_bid}`);
        }

        function renderCarouselGraph(graph) {
            const container = document.getElementById('carousel-graph');
            container.innerHTML = '';
            const width = container.clientWidth || 800;
            const height = 380;
            const svg = d3.select('#carousel-graph').append('svg').attr('width', width).attr('height', height)
                .call(d3.zoom().on('zoom', (event) => g.attr('transform', event.transform)));
            const g = svg.append('g');

            const nodes = graph.nodes || [];
            const links = (graph.links || []).map(l => ({ ...l }));
            const link = g.append('g').selectAll('line').data(links).enter().append('line')
                .attr('stroke', '#9ca3af').attr('stroke-width', d => 1 + Math.min(6, d.co_sales || 1));
            const node = g.append('g').selectAll('circle').data(nodes).enter().append('circle')
                .attr('r', 8).attr('fill', '#10b981').attr('stroke', '#fff').attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', (event, d) => { if (!event.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
                    .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
                    .on('end', (event, d) => { if (!event.active) sim.alphaTarget(0); d.fx = null; d.fy = null; }));
            node.append('title').text(d => d.name);
            const label = g.append('g').selectAll('text').data(nodes).enter().append('text')
                .text(d => d.name).attr('font-size', '11px').attr('dy', '-1.1em').attr('text-anchor', 'middle').attr('fill', '#374151');

            const sim = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-160))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(14));
            sim.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('cx', d => d.x).attr('cy', d => d.y);
                label.attr('x', d => d.x).attr('y', d => d.y);
            });
        }

        function renderCarouselDetailsTable(sales, participantsByLot) {
            const tbody = document.getElementById('carousel-details-table-body');
            tbody.innerHTML = '';
            sales.forEach(s => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => showLotModal(s.lot_id);
                const partsKey = String(s.lot_id);
                const parts = (participantsByLot && (participantsByLot[partsKey] || participantsByLot[s.lot_id])) ? (participantsByLot[partsKey] || participantsByLot[s.lot_id]) : [];
                const participantsPreview = parts.slice(0, 5).map(p => p.bidder_login).join(', ') + (parts.length > 5 ? '…' : '');
                row.innerHTML = `
                    <td class="px-4 py-2 text-sm text-gray-900">${new Date(s.auction_end_date).toLocaleString()}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${s.auction_number}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${s.winner_login}</td>
                    <td class="px-4 py-2 text-sm text-gray-900">${s.winning_bid}</td>
                    <td class="px-4 py-2 text-sm text-gray-700">${participantsPreview || 'нет данных'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Замирание торгов
        async function loadAbandonmentAnalysis() {
            const minBids = document.getElementById('abandonmentMinBids').value;
            const maxSeconds = document.getElementById('abandonmentMaxSeconds').value;
            
            try {
                const response = await fetch(`/api/analytics/abandonment-analysis?min_bids=${minBids}&max_seconds=${maxSeconds}`);
                const data = await response.json();
                
                if (data.success) {
                    displayAbandonmentAnalysis(data.data);
                    document.getElementById('abandonment-analysis-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка загрузки замирания:', error);
                alert('Ошибка загрузки данных');
            }
        }

        function displayAbandonmentAnalysis(data) {
            const tbody = document.getElementById('abandonment-analysis-table');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => showLotModal(item.lot_id);
                const maxGapHours = (item.max_gap_seconds != null && !isNaN(item.max_gap_seconds)) ? (Number(item.max_gap_seconds) / 3600) : null;
                const avgGapHours = (item.avg_gap_seconds != null && !isNaN(item.avg_gap_seconds)) ? (Number(item.avg_gap_seconds) / 3600) : null;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.auction_number}-${item.lot_number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.winner_login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.total_bids}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${maxGapHours != null ? maxGapHours.toFixed(2) + ' ч' : '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.suspicious_patterns.join(', ')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(item.risk_level)}">
                            ${item.risk_level}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Саморазгон/Самовыкуп
        async function loadSelfBoostAnalysis() {
            const minConsecutive = document.getElementById('selfBoostMinConsecutive').value;
            const minShare = document.getElementById('selfBoostMinShare').value;
            const maxUnique = document.getElementById('selfBoostMaxUnique').value;
            const months = document.getElementById('selfBoostMonths').value;
            try {
                const response = await fetch(`/api/analytics/self-boost?min_consecutive=${minConsecutive}&min_self_share=${minShare}&max_unique_bidders=${maxUnique}&months=${months}`);
                const data = await response.json();
                if (data.success) {
                    displaySelfBoost(data.data);
                    document.getElementById('self-boost-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка загрузки саморазгона:', error);
                alert('Ошибка загрузки данных');
            }
        }

        function displaySelfBoost(data) {
            const tbody = document.getElementById('self-boost-table');
            tbody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => showLotModal(item.lot_id);
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.auction_number}-${item.lot_number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.winner_login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.total_bids}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.max_consecutive_self_raises}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.self_raises_share*100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.unique_bidders}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.patterns.join(', ')}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(item.risk_level)}">${item.risk_level}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Стратегии разгона цен
        async function loadPricingStrategies() {
            const minBids = document.getElementById('pricingMinBids').value;
            const minMultiplier = document.getElementById('pricingMinMultiplier').value;
            
            try {
                const response = await fetch(`/api/analytics/pricing-strategies?min_bids=${minBids}&min_price_multiplier=${minMultiplier}`);
                const data = await response.json();
                
                if (data.success) {
                    displayPricingStrategies(data.data);
                    document.getElementById('pricing-strategies-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка загрузки стратегий:', error);
                alert('Ошибка загрузки данных');
            }
        }

        function displayPricingStrategies(data) {
            const tbody = document.getElementById('pricing-strategies-table');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.auction_number}-${item.lot_number}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.winner_login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.final_price_multiplier.toFixed(2)}x</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.total_bids}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.fast_bid_ratio * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.strategy_type}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(item.risk_level)}">
                            ${item.risk_level}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Тактики приманки
        async function loadDecoyTactics() {
            const minLots = document.getElementById('decoyMinLots').value;
            const maxPriceDiff = document.getElementById('decoyMaxPriceDiff').value;
            
            try {
                const response = await fetch(`/api/analytics/decoy-tactics?min_lots=${minLots}&max_price_diff=${maxPriceDiff}`);
                const data = await response.json();
                
                if (data.success) {
                    displayDecoyTactics(data.data);
                    document.getElementById('decoy-tactics-results').classList.remove('hidden');
                } else {
                    alert('Ошибка: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка загрузки тактик приманки:', error);
                alert('Ошибка загрузки данных');
            }
        }

        function displayDecoyTactics(data) {
            const tbody = document.getElementById('decoy-tactics-table');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.winner_login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.total_purchases}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.min_price.toFixed(0)}₽ - ${item.max_price.toFixed(0)}₽</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.high_multiplier_ratio * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(item.quick_purchases_ratio * 100).toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.tactic_type}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRiskClass(item.risk_level)}">
                            ${item.risk_level}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Вспомогательная функция для определения CSS класса риска
        function getRiskClass(riskLevel) {
            switch(riskLevel) {
                case 'КРИТИЧЕСКИ ПОДОЗРИТЕЛЬНО':
                    return 'bg-red-100 text-red-800';
                case 'ПОДОЗРИТЕЛЬНО':
                    return 'bg-orange-100 text-orange-800';
                case 'ВНИМАНИЕ':
                    return 'bg-yellow-100 text-yellow-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Initialize page
        loadStats();
    </script>
</body>
</html>
