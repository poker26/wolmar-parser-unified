#!/bin/bash

# ะะพะปะฝัะน ัะบัะธะฟั ัะฐะทะฒะตัััะฒะฐะฝะธั ัะธััะตะผั ะฝะฐ ัะตัะฒะตัะต
# ะฃัะธััะฒะฐะตั ะฒัะต ะฟัะพะฑะปะตะผั ั Git ะธ ัะฐะทะฒะตัััะฒะฐะตั ะพะฑะต ัะฐััะธ ัะธััะตะผั

echo "๐ ะะพะปะฝะพะต ัะฐะทะฒะตัััะฒะฐะฝะธะต ัะธััะตะผั ะฝะฐ ัะตัะฒะตัะต..."
echo "============================================="

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฝะฐ ัะตัะฒะตัะต
if [ ! -f "/var/www/wolmar-parser/server.js" ]; then
    echo "โ ะัะธะฑะบะฐ: ะกะบัะธะฟั ะดะพะปะถะตะฝ ะทะฐะฟััะบะฐัััั ะฝะฐ ัะตัะฒะตัะต ะฒ /var/www/wolmar-parser"
    exit 1
fi

cd /var/www/wolmar-parser

echo "๐ ะขะตะบััะธะน ััะฐััั:"
git status
git branch --show-current

echo ""
echo "๐งน ะญะขะะ 1: ะัะธััะบะฐ ะฝะตะพััะปะตะถะธะฒะฐะตะผัั ัะฐะนะปะพะฒ..."

# ะกะพะทะดะฐะตะผ ัะตะทะตัะฒะฝัั ะบะพะฟะธั ะฒะฐะถะฝัั ัะฐะนะปะพะฒ
backup_dir="backup-$(date +%Y%m%d_%H%M%S)"
mkdir -p "$backup_dir"

# ะกะพััะฐะฝัะตะผ ะฒะฐะถะฝัะต ัะฐะนะปั
if [ -f "server.js.backup" ]; then
    cp server.js.backup "$backup_dir/"
    echo "โ ะกะพััะฐะฝะตะฝ server.js.backup"
fi

if [ -f "schedule.json" ]; then
    cp schedule.json "$backup_dir/"
    echo "โ ะกะพััะฐะฝะตะฝ schedule.json"
fi

if [ -f "predictions_progress_968.json" ]; then
    cp predictions_progress_968.json "$backup_dir/"
    echo "โ ะกะพััะฐะฝะตะฝ predictions_progress_968.json"
fi

# ะฃะดะฐะปัะตะผ ะฝะตะพััะปะตะถะธะฒะฐะตะผัะต ัะฐะนะปั
git clean -fd

echo ""
echo "๐ ะญะขะะ 2: ะะตัะตะบะปััะตะฝะธะต ะฝะฐ ะพัะฝะพะฒะฝัั ะฒะตัะบั..."
git checkout catalog-parser --force

if [ $? -eq 0 ]; then
    echo "โ ะะตัะตะบะปััะธะปะธัั ะฝะฐ ะฒะตัะบั catalog-parser"
else
    echo "โ ะัะธะฑะบะฐ ะฟะตัะตะบะปััะตะฝะธั ะฝะฐ ะฒะตัะบั catalog-parser"
    exit 1
fi

echo ""
echo "๐ฅ ะญะขะะ 3: ะะพะปััะตะฝะธะต ะฟะพัะปะตะดะฝะธั ะธะทะผะตะฝะตะฝะธะน..."
git pull origin catalog-parser

if [ $? -eq 0 ]; then
    echo "โ ะะทะผะตะฝะตะฝะธั ะฟะพะปััะตะฝั ั GitHub"
else
    echo "โ ะัะธะฑะบะฐ ะฟะพะปััะตะฝะธั ะธะทะผะตะฝะตะฝะธะน"
    exit 1
fi

echo ""
echo "๐ฆ ะญะขะะ 4: ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."
npm install

if [ $? -eq 0 ]; then
    echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"
else
    echo "โ ะัะธะฑะบะฐ ัััะฐะฝะพะฒะบะธ ะทะฐะฒะธัะธะผะพััะตะน"
    exit 1
fi

echo ""
echo "๐ ะญะขะะ 5: ะะฐัััะพะนะบะฐ PM2 ะดะปั ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."

# ะััะฐะฝะพะฒะธัั ัััะตััะฒัััะธะต ะฟัะพัะตััั
pm2 stop all 2>/dev/null || true

# ะะฐะฟัััะธัั ะพัะฝะพะฒะฝะพะน ัะตัะฒะตั
pm2 start ecosystem.config.js

if [ $? -eq 0 ]; then
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะทะฐะฟััะตะฝ ัะตัะตะท PM2"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ"
    exit 1
fi

echo ""
echo "๐ ะญะขะะ 6: ะะฐะทะฒะตัััะฒะฐะฝะธะต ะบะฐัะฐะปะพะณะฐ ะผะพะฝะตั..."

# ะะตัะตะบะปััะธัััั ะฝะฐ ะฒะตัะบั ะบะฐัะฐะปะพะณะฐ
git checkout web-interface

if [ $? -eq 0 ]; then
    echo "โ ะะตัะตะบะปััะธะปะธัั ะฝะฐ ะฒะตัะบั web-interface"
else
    echo "โ ะัะธะฑะบะฐ ะฟะตัะตะบะปััะตะฝะธั ะฝะฐ ะฒะตัะบั web-interface"
    exit 1
fi

# ะกะพะทะดะฐัั ะดะธัะตะบัะพัะธั ะดะปั ะบะฐัะฐะปะพะณะฐ
mkdir -p /var/www/catalog-interface
cd /var/www/catalog-interface

# ะะพะฟะธัะพะฒะฐัั ัะฐะนะปั ะบะฐัะฐะปะพะณะฐ
cp -r /var/www/wolmar-parser/public/ ./
cp /var/www/wolmar-parser/server.js ./
cp /var/www/wolmar-parser/package.json ./
cp /var/www/wolmar-parser/package-lock.json ./
cp /var/www/wolmar-parser/config.example.js ./

echo "โ ะคะฐะนะปั ะบะฐัะฐะปะพะณะฐ ัะบะพะฟะธัะพะฒะฐะฝั"

# ะะฐัััะพะธัั ะบะฐัะฐะปะพะณ
cp config.example.js config.js
echo "โ ะะพะฝัะธะณััะฐัะธั ะบะฐัะฐะปะพะณะฐ ัะพะทะดะฐะฝะฐ"

# ะฃััะฐะฝะพะฒะธัั ะทะฐะฒะธัะธะผะพััะธ ะบะฐัะฐะปะพะณะฐ
npm install

if [ $? -eq 0 ]; then
    echo "โ ะะฐะฒะธัะธะผะพััะธ ะบะฐัะฐะปะพะณะฐ ัััะฐะฝะพะฒะปะตะฝั"
else
    echo "โ ะัะธะฑะบะฐ ัััะฐะฝะพะฒะบะธ ะทะฐะฒะธัะธะผะพััะตะน ะบะฐัะฐะปะพะณะฐ"
    exit 1
fi

# ะะฐะฟัััะธัั ะบะฐัะฐะปะพะณ ัะตัะตะท PM2
pm2 start server.js --name "catalog-interface"

if [ $? -eq 0 ]; then
    echo "โ ะะฐัะฐะปะพะณ ะทะฐะฟััะตะฝ ัะตัะตะท PM2"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะบะฐัะฐะปะพะณะฐ"
    exit 1
fi

echo ""
echo "๐ง ะญะขะะ 7: ะะฐัััะพะนะบะฐ ะผะพะฝะธัะพัะธะฝะณะฐ..."

# ะะฐัััะพะธัั ะฐะฒัะพะทะฐะฟััะบ PM2
pm2 save
pm2 startup

# ะะฐัััะพะธัั logrotate
pm2 install pm2-logrotate 2>/dev/null || true

echo ""
echo "๐ ะญะขะะ 8: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ..."

# ะัะพะฒะตัะธัั ััะฐััั PM2
pm2 status

# ะัะพะฒะตัะธัั ัะฐะฑะพัั ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ
echo "๐ ะัะพะฒะตัะบะฐ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."
curl -s http://localhost:3001/api/health > /dev/null
if [ $? -eq 0 ]; then
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ัะฐะฑะพัะฐะตั"
else
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั"
fi

# ะัะพะฒะตัะธัั ัะฐะฑะพัั ะบะฐัะฐะปะพะณะฐ
echo "๐ ะัะพะฒะตัะบะฐ ะบะฐัะฐะปะพะณะฐ ะผะพะฝะตั..."
curl -s http://localhost:3000/api/auctions > /dev/null
if [ $? -eq 0 ]; then
    echo "โ ะะฐัะฐะปะพะณ ะผะพะฝะตั ัะฐะฑะพัะฐะตั"
else
    echo "โ ะะฐัะฐะปะพะณ ะผะพะฝะตั ะฝะต ะพัะฒะตัะฐะตั"
fi

echo ""
echo "โ ะะะะะะะขะซะะะะะ ะะะะะะจะะะ!"
echo "============================================="
echo "๐ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั: http://46.173.19.68:3001"
echo "๐ ะะฐัะฐะปะพะณ ะผะพะฝะตั: http://46.173.19.68:3000"
echo "๐พ ะะตะทะตัะฒะฝัะต ะบะพะฟะธะธ: $backup_dir/"
echo "๐ ะะพะฝะธัะพัะธะฝะณ: pm2 status"
echo "๐ ะะพะณะธ: pm2 logs"
