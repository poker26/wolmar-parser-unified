#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะธัะฟัะฐะฒะปะตะฝะธั ะฟัะพะฑะปะตะผ ั ัะตัะฒะตัะพะผ
# ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตั ัะฐะฑะพัั ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ ะธ ะบะฐัะฐะปะพะณะฐ ะผะพะฝะตั

echo "๐ง ะัะฟัะฐะฒะปะตะฝะธะต ะฟัะพะฑะปะตะผ ั ัะตัะฒะตัะพะผ..."
echo "===================================="

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฝะฐ ัะตัะฒะตัะต
if [ ! -f "/var/www/wolmar-parser/server.js" ]; then
    echo "โ ะัะธะฑะบะฐ: ะกะบัะธะฟั ะดะพะปะถะตะฝ ะทะฐะฟััะบะฐัััั ะฝะฐ ัะตัะฒะตัะต ะฒ /var/www/wolmar-parser"
    exit 1
fi

cd /var/www/wolmar-parser

echo "๐ ะญะขะะ 1: ะััะฐะฝะพะฒะบะฐ ะฒัะตั ะฟัะพัะตััะพะฒ PM2..."
pm2 stop all
pm2 delete all

echo ""
echo "๐ ะญะขะะ 2: ะะตัะตะบะปััะตะฝะธะต ะฝะฐ ะพัะฝะพะฒะฝัั ะฒะตัะบั..."
git checkout catalog-parser --force
git pull origin catalog-parser

echo ""
echo "๐ ะญะขะะ 3: ะะพัััะฐะฝะพะฒะปะตะฝะธะต ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."

# ะัะพะฒะตััะตะผ, ััะพ API endpoints ะบะฐัะฐะปะพะณะฐ ัะดะฐะปะตะฝั ะธะท ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ
if grep -q "/api/auctions" server.js; then
    echo "โ๏ธ ะ ะพัะฝะพะฒะฝะพะผ ัะตัะฒะตัะต ะฝะฐะนะดะตะฝั endpoints ะบะฐัะฐะปะพะณะฐ, ัะดะฐะปัะตะผ..."
    node remove-catalog-endpoints.js
else
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะพัะธัะตะฝ ะพั endpoints ะบะฐัะฐะปะพะณะฐ"
fi

# ะะฐะฟััะบะฐะตะผ ะพัะฝะพะฒะฝะพะน ัะตัะฒะตั
pm2 start ecosystem.config.js

if [ $? -eq 0 ]; then
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะทะฐะฟััะตะฝ"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ"
    exit 1
fi

echo ""
echo "๐ ะญะขะะ 4: ะะฐัััะพะนะบะฐ ะบะฐัะฐะปะพะณะฐ ะผะพะฝะตั..."

# ะะตัะตะบะปััะฐะตะผัั ะฝะฐ ะฒะตัะบั ะบะฐัะฐะปะพะณะฐ
git checkout web-interface

if [ $? -eq 0 ]; then
    echo "โ ะะตัะตะบะปััะธะปะธัั ะฝะฐ ะฒะตัะบั web-interface"
else
    echo "โ ะัะธะฑะบะฐ ะฟะตัะตะบะปััะตะฝะธั ะฝะฐ ะฒะตัะบั web-interface"
    exit 1
fi

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะบะฐัะฐะปะพะณะฐ
mkdir -p /var/www/catalog-interface
cd /var/www/catalog-interface

# ะะพะฟะธััะตะผ ัะฐะนะปั ะบะฐัะฐะปะพะณะฐ
cp -r /var/www/wolmar-parser/public/ ./
cp /var/www/wolmar-parser/server.js ./
cp /var/www/wolmar-parser/package.json ./
cp /var/www/wolmar-parser/package-lock.json ./
cp /var/www/wolmar-parser/config.example.js ./

# ะะฐัััะฐะธะฒะฐะตะผ ะบะฐัะฐะปะพะณ
cp config.example.js config.js

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
npm install

# ะะฐะฟััะบะฐะตะผ ะบะฐัะฐะปะพะณ
pm2 start server.js --name "catalog-interface"

if [ $? -eq 0 ]; then
    echo "โ ะะฐัะฐะปะพะณ ะผะพะฝะตั ะทะฐะฟััะตะฝ"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะบะฐัะฐะปะพะณะฐ ะผะพะฝะตั"
    exit 1
fi

echo ""
echo "๐ ะญะขะะ 5: ะะฐัััะพะนะบะฐ PM2..."
pm2 save
pm2 startup

echo ""
echo "๐ ะญะขะะ 6: ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ..."

# ะัะพะฒะตััะตะผ ััะฐััั PM2
pm2 status

# ะัะพะฒะตััะตะผ ะพัะฝะพะฒะฝะพะน ัะตัะฒะตั
echo "๐ ะัะพะฒะตัะบะฐ ะพัะฝะพะฒะฝะพะณะพ ัะตัะฒะตัะฐ..."
curl -s http://localhost:3001/api/health > /dev/null
if [ $? -eq 0 ]; then
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ัะฐะฑะพัะฐะตั ะฝะฐ ะฟะพััั 3001"
else
    echo "โ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั"
fi

# ะัะพะฒะตััะตะผ ะบะฐัะฐะปะพะณ
echo "๐ ะัะพะฒะตัะบะฐ ะบะฐัะฐะปะพะณะฐ ะผะพะฝะตั..."
curl -s http://localhost:3000/api/auctions > /dev/null
if [ $? -eq 0 ]; then
    echo "โ ะะฐัะฐะปะพะณ ะผะพะฝะตั ัะฐะฑะพัะฐะตั ะฝะฐ ะฟะพััั 3000"
else
    echo "โ ะะฐัะฐะปะพะณ ะผะพะฝะตั ะฝะต ะพัะฒะตัะฐะตั"
fi

echo ""
echo "โ ะะกะะะะะะะะะ ะะะะะะจะะะ!"
echo "============================================="
echo "๐ ะัะฝะพะฒะฝะพะน ัะตัะฒะตั: http://46.173.19.68:3001"
echo "๐ ะะฐัะฐะปะพะณ ะผะพะฝะตั: http://46.173.19.68:3000"
echo "๐ ะะพะฝะธัะพัะธะฝะณ: pm2 status"
echo "๐ ะะพะณะธ: pm2 logs"
